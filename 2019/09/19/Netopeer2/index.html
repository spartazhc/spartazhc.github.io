<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="https://fonts.loli.net/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="restconf,">










<meta name="description" content="这篇相对clixon_backend_restconf更乱一些，内容从开头的Netopeer2代码阅读到后续的RESTCONF实现细节，差别很大。这篇的有效内容更多，原因是我实现的RESTCONF server和Netopeer2-server用的东西更接近。 同样的，后续可能会把和RESTCONF实现相关的部分再抽离出来。">
<meta name="keywords" content="restconf">
<meta property="og:type" content="article">
<meta property="og:title" content="Netopeer2">
<meta property="og:url" content="https://spartazhc.github.io/2019/09/19/Netopeer2/index.html">
<meta property="og:site_name" content="spartazhc&#39;s blog">
<meta property="og:description" content="这篇相对clixon_backend_restconf更乱一些，内容从开头的Netopeer2代码阅读到后续的RESTCONF实现细节，差别很大。这篇的有效内容更多，原因是我实现的RESTCONF server和Netopeer2-server用的东西更接近。 同样的，后续可能会把和RESTCONF实现相关的部分再抽离出来。">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-09-19T14:05:51.527Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Netopeer2">
<meta name="twitter:description" content="这篇相对clixon_backend_restconf更乱一些，内容从开头的Netopeer2代码阅读到后续的RESTCONF实现细节，差别很大。这篇的有效内容更多，原因是我实现的RESTCONF server和Netopeer2-server用的东西更接近。 同样的，后续可能会把和RESTCONF实现相关的部分再抽离出来。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":20,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://spartazhc.github.io/2019/09/19/Netopeer2/">





  <title>Netopeer2 | spartazhc's blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">spartazhc's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://spartazhc.github.io/2019/09/19/Netopeer2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="spartazhc">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="spartazhc's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Netopeer2</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-19T21:54:49+08:00">
                2019-09-19
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/restconf/" itemprop="url" rel="index">
                    <span itemprop="name">restconf</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/09/19/Netopeer2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/09/19/Netopeer2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/09/19/Netopeer2/" class="leancloud_visitors" data-flag-title="Netopeer2">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      
        <div class="note default"><p>这篇相对<a href="/2019/09/19/clixon-backend-restconf/" title="clixon_backend_restconf">clixon_backend_restconf</a>更乱一些，内容从开头的Netopeer2代码阅读到后续的RESTCONF实现细节，差别很大。这篇的有效内容更多，原因是我实现的RESTCONF server和Netopeer2-server用的东西更接近。</p>
<p>同样的，后续可能会把和RESTCONF实现相关的部分再抽离出来。</p></div>

<a id="more"></a>

<h3 id="libyang-数据结构"><a href="#libyang-数据结构" class="headerlink" title="libyang 数据结构"></a>libyang 数据结构</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief Generic structure for a data node, directly applicable to the data nodes defined as #LYS_CONTAINER, #LYS_LIST</span></span><br><span class="line"><span class="comment"> * and #LYS_CHOICE.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Completely fits to containers and choices and is compatible (can be used interchangeably except the #child member)</span></span><br><span class="line"><span class="comment"> * with all other lyd_node_* structures. All data nodes are provides as ::lyd_node structure by default.</span></span><br><span class="line"><span class="comment"> * According to the schema's ::lys_node#nodetype member, the specific object is supposed to be cast to</span></span><br><span class="line"><span class="comment"> * ::lyd_node_leaf_list or ::lyd_node_anydata structures. This structure fits only to #LYS_CONTAINER, #LYS_LIST and</span></span><br><span class="line"><span class="comment"> * #LYS_CHOICE values.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * To traverse all the child elements or attributes, use #LY_TREE_FOR or #LY_TREE_FOR_SAFE macro. To traverse</span></span><br><span class="line"><span class="comment"> * the whole subtree, use #LY_TREE_DFS_BEGIN macro.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lyd_node</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lys_node</span> *<span class="title">schema</span>;</span>         <span class="comment">/**&lt; pointer to the schema definition of this node */</span></span><br><span class="line">    <span class="keyword">uint8_t</span> validity;                <span class="comment">/**&lt; [validity flags](@ref validityflags) */</span></span><br><span class="line">    <span class="keyword">uint8_t</span> dflt:<span class="number">1</span>;                  <span class="comment">/**&lt; flag for implicit default node */</span></span><br><span class="line">    <span class="keyword">uint8_t</span> when_status:<span class="number">3</span>;           <span class="comment">/**&lt; bit for checking if the when-stmt condition is</span></span><br><span class="line"><span class="comment">    									  resolved - internal use only,</span></span><br><span class="line"><span class="comment">                                          do not use this value! */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lyd_attr</span> *<span class="title">attr</span>;</span>          <span class="comment">/**&lt; pointer to the list of attributes of this node */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lyd_node</span> *<span class="title">next</span>;</span> 			<span class="comment">/**&lt; pointer to the next sibling node </span></span><br><span class="line"><span class="comment">    									(NULL if there is no one) */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lyd_node</span> *<span class="title">prev</span>;</span>           </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lyd_node</span> *<span class="title">parent</span>;</span> <span class="comment">/**&lt; pointer to the parent node, NULL in case of root node */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">lyd_node</span> *<span class="title">child</span>;</span>          </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>libyang、libnetconf2</li>
<li>sysrepo 依赖 libyang</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main里的流程 server-init()</span></span><br><span class="line"><span class="comment">/* connect to the sysrepo */</span></span><br><span class="line">rc = sr_connect(<span class="string">"netopeer2"</span>, SR_CONN_DAEMON_REQUIRED | SR_CONN_DAEMON_START, &amp;np2srv.sr_conn);</span><br><span class="line"><span class="comment">/* server session */</span></span><br><span class="line">np2srv.sr_sess.ds = SR_DS_STARTUP;</span><br><span class="line">np2srv.sr_sess.opts = SR_SESS_DEFAULT;</span><br><span class="line">rc = sr_session_start(np2srv.sr_conn, np2srv.sr_sess.ds, np2srv.sr_sess.opts, &amp;np2srv.sr_sess.srs);</span><br><span class="line"><span class="comment">/* init libyang context with schemas */</span>--libyang TODO</span><br><span class="line">np2srv_init_schemas()</span><br><span class="line"><span class="comment">/* init libnetconf2 */</span></span><br><span class="line">nc_server_init(np2srv.ly_ctx)</span><br><span class="line">    </span><br><span class="line"><span class="comment">/* set NETCONF operations callbacks */</span></span><br><span class="line">snode = ly_ctx_get_node(np2srv.ly_ctx, <span class="literal">NULL</span>, <span class="string">"/ietf-netconf:get-config"</span>, <span class="number">0</span>);</span><br><span class="line">nc_set_rpc_callback(snode, op_get);</span><br><span class="line"></span><br><span class="line">snode = ly_ctx_get_node(np2srv.ly_ctx, <span class="literal">NULL</span>, <span class="string">"/ietf-netconf:edit-config"</span>, <span class="number">0</span>);</span><br><span class="line">nc_set_rpc_callback(snode, op_editconfig);</span><br></pre></td></tr></table></figure>

<ul>
<li>经常用到<code>np2srv_sr_session_refresh(srs, NULL);</code>注意理解</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 举例 去netopeer2/server/op_get_config.c 搜索sr_ 可以看所有和sysrepo相关的函数</span></span><br><span class="line"><span class="comment">// np2srv_ : netopeer2 to sysrepo v???</span></span><br><span class="line"><span class="comment">// op_sr2ly_ : operation sysrepo to libyang</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nc_server_reply</span> *</span></span><br><span class="line"><span class="class"><span class="title">op_get</span>(<span class="title">struct</span> <span class="title">lyd_node</span> *<span class="title">rpc</span>, <span class="title">struct</span> <span class="title">nc_session</span> *<span class="title">ncs</span>)</span></span><br><span class="line"><span class="class">    // 先是一堆看不懂的<span class="title">libyang</span>、<span class="title">libnetconf2</span>有关的操作（主要就是这一些）</span></span><br><span class="line"><span class="class">    // 以及一些<span class="title">ds</span>的<span class="title">update</span>什么的</span></span><br><span class="line"><span class="class">    // <span class="title">filters</span></span></span><br><span class="line"><span class="class">    // 能知道开始用<span class="title">sysrepo</span>的接口的是这一句：</span></span><br><span class="line"><span class="class">    /*</span></span><br><span class="line"><span class="class">     * <span class="title">create</span> <span class="title">the</span> <span class="title">data</span> <span class="title">tree</span> <span class="title">for</span> <span class="title">the</span> <span class="title">data</span> <span class="title">reply</span></span></span><br><span class="line"><span class="class">     */</span></span><br><span class="line"><span class="class">    <span class="title">for</span> (<span class="title">i</span> = 0;</span> (<span class="keyword">signed</span>)i &lt; filter_count; i++) &#123;</span><br><span class="line">        <span class="comment">/* create the subtree */</span></span><br><span class="line">        <span class="keyword">if</span> (op_sr2ly_subtree(sessions-&gt;srs, &amp;root, filters[i], &amp;ereply)) &#123;</span><br><span class="line">            <span class="keyword">goto</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//后面又是libyang和libnetconf2</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 接上，</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">op_sr2ly_subtree(<span class="keyword">sr_session_ctx_t</span> *srs, struct lyd_node **root, <span class="keyword">const</span> <span class="keyword">char</span> *subtree_xpath, struct nc_server_reply **ereply)</span><br><span class="line">    <span class="comment">// 涉及sysrepo的都上np2srv_sr_*的函数，这些函数在netopeer2/server/operations.c文件中重新封装，这个文件有3000+行</span></span><br><span class="line">	rc = np2srv_sr_get_items_iter(srs, full_subtree_xpath, &amp;sriter, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">while</span> ((!np2srv_sr_get_item_next(srs, sriter, &amp;value, <span class="literal">NULL</span>))) &#123;</span><br><span class="line">        <span class="keyword">if</span> (op_sr2ly(*root, value, &amp;node, &amp;cache)) &#123;</span><br><span class="line">            sr_free_val(value);</span><br><span class="line">            sr_free_val_iter(sriter);</span><br><span class="line">            <span class="keyword">goto</span> error;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(*root)) &#123;</span><br><span class="line">            *root = node;</span><br><span class="line">        &#125;</span><br><span class="line">        sr_free_val(value);</span><br><span class="line">    &#125;</span><br><span class="line">    sr_free_val_iter(sriter);</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 去netopeer2/server/operations.c 搜索sr_get_item</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">np2srv_sr_get_item</span><span class="params">(<span class="keyword">sr_session_ctx_t</span> *srs, <span class="keyword">const</span> <span class="keyword">char</span> *xpath, </span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">sr_val_t</span> **value, struct nc_server_reply **ereply)</span></span></span><br><span class="line"><span class="function">    <span class="title">pthread_rwlock_rdlock</span><span class="params">(&amp;sr_lock)</span></span>; <span class="comment">// sr_lock</span></span><br><span class="line">    <span class="keyword">if</span> (!np2srv.disconnected) &#123;</span><br><span class="line">        rc = sr_get_item(srs, xpath, value);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 后面是一些错误处理</span></span><br><span class="line">	pthread_rwlock_unlock(&amp;sr_lock);</span><br></pre></td></tr></table></figure>

<h3 id="schema"><a href="#schema" class="headerlink" title="schema"></a>schema</h3><ul>
<li><p>np2srv_init_schemas(void)</p>
</li>
<li><p>从sysrepo里面获取yang的schema</p>
</li>
<li><p>build libyang context</p>
</li>
<li><p><em>use modules from sysrepo</em></p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief Structure that contains information about a module installed in sysrepo.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">sr_schema_s</span> &#123;</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Memory context used internally by Sysrepo for efficient storage</span></span><br><span class="line"><span class="comment">     * and conversion of this structure.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">sr_mem_ctx_t</span> *_sr_mem;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *module_name;         <span class="comment">/**&lt; Name of the module. */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *ns;                  <span class="comment">/**&lt; Namespace of the module used in @ref xp_page "XPath". */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *prefix;              <span class="comment">/**&lt; Prefix of the module. */</span></span><br><span class="line">    <span class="keyword">bool</span> installed;                  <span class="comment">/**&lt; TRUE if the module was explicitly installed. */</span></span><br><span class="line">    <span class="keyword">bool</span> implemented;                <span class="comment">/**&lt; TRUE if the module is implemented (does not have to be installed),</span></span><br><span class="line"><span class="comment">                                          not just imported. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">sr_sch_revision_t</span> revision;      <span class="comment">/**&lt; Revision the module. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">sr_sch_submodule_t</span> *submodules;  <span class="comment">/**&lt; Array of all installed submodules of the module. */</span></span><br><span class="line">    <span class="keyword">size_t</span> submodule_count;          <span class="comment">/**&lt; Number of module's submodules. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> **enabled_features;         <span class="comment">/**&lt; Array of enabled features */</span></span><br><span class="line">    <span class="keyword">size_t</span> enabled_feature_cnt;      <span class="comment">/**&lt; Number of enabled feature */</span></span><br><span class="line">&#125; <span class="keyword">sr_schema_t</span>;</span><br></pre></td></tr></table></figure>

<h3 id="libyang-context-ly-ctx"><a href="#libyang-context-ly-ctx" class="headerlink" title="libyang context ly_ctx"></a>libyang context ly_ctx</h3><h3 id="重要的数据结构"><a href="#重要的数据结构" class="headerlink" title="重要的数据结构"></a>重要的数据结构</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* NETCONF - SYSREPO connections */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">np2_sessions</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nc_session</span> *<span class="title">ncs</span>;</span> <span class="comment">/* NETCONF session */</span></span><br><span class="line">    <span class="keyword">sr_session_ctx_t</span> *srs;  <span class="comment">/* SYSREPO session */</span></span><br><span class="line">    <span class="keyword">sr_datastore_t</span> ds;      <span class="comment">/* current SYSREPO datastore */</span></span><br><span class="line">    <span class="keyword">sr_sess_options_t</span> opts; <span class="comment">/* current SYSREPO session options */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> flags;              <span class="comment">/* various flags */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NP2S_CAND_CHANGED 0x01</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Netopeer server internal data */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">np2srv</span> &#123;</span></span><br><span class="line">    <span class="keyword">sr_conn_ctx_t</span> *sr_conn;        <span class="comment">/**&lt; sysrepo connection */</span></span><br><span class="line">    <span class="keyword">int</span> disconnected;              <span class="comment">/**&lt; flag marking that server is currently not connected to sysrepo */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">np2_sessions</span> <span class="title">sr_sess</span>;</span>   <span class="comment">/**&lt; Netopeer's sysrepo sessions */</span></span><br><span class="line">    <span class="keyword">sr_subscription_ctx_t</span> *sr_subscr; <span class="comment">/**&lt; sysrepo subscription context */</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nc_pollsession</span> *<span class="title">nc_ps</span>;</span>  <span class="comment">/**&lt; libnetconf2 pollsession structure */</span></span><br><span class="line">    <span class="keyword">uint16_t</span> nc_max_sessions;      <span class="comment">/**&lt; maximum number of running sessions */</span></span><br><span class="line">    <span class="keyword">pthread_t</span> workers[NP2SRV_THREAD_COUNT]; <span class="comment">/**&lt; worker threads handling sessions */</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ly_ctx</span> *<span class="title">ly_ctx</span>;</span>         <span class="comment">/**&lt; libyang's context */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> NP2SRV_ENABLED_LY_CTX_INFO_CACHE</span></span><br><span class="line">    <span class="keyword">uint16_t</span> cached_ly_ctx_module_set_id; <span class="comment">/**&lt; module-set-id at the time ly_ctx_info was last cached */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lyd_node</span> *<span class="title">ly_ctx_info_cache</span>;</span> <span class="comment">/**&lt; a cache of calling ly_ctx_info on the ly_ctx */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">pthread_rwlock_t</span> ly_ctx_lock;  <span class="comment">/**&lt; libyang's context rwlock */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ly_ctx</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dict_table</span> <span class="title">dict</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ly_modules_list</span> <span class="title">models</span>;</span></span><br><span class="line">    ly_module_imp_clb imp_clb;</span><br><span class="line">    <span class="keyword">void</span> *imp_clb_data;</span><br><span class="line">    ly_module_data_clb data_clb;</span><br><span class="line">    <span class="keyword">void</span> *data_clb_data;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> LY_ENABLED_LYD_PRIV</span></span><br><span class="line">    <span class="keyword">void</span> *(*priv_dup_clb)(<span class="keyword">const</span> <span class="keyword">void</span> *priv);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">pthread_key_t</span> errlist_key;</span><br><span class="line">    <span class="keyword">uint8_t</span> internal_module_count;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="libyang"><a href="#libyang" class="headerlink" title="libyang"></a>libyang</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief Structure describing an element in an XML tree.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If the name item is NULL, then the content is part of the mixed content.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Children elements are connected in a half ring doubly linked list:</span></span><br><span class="line"><span class="comment"> * - first's prev pointer points to the last children</span></span><br><span class="line"><span class="comment"> * - last's next pointer is NULL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lyxml_elem</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> flags;                      <span class="comment">/**&lt; special flags */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LYXML_ELEM_MIXED 0x01 <span class="comment">/* element contains mixed content */</span></span></span><br><span class="line"><span class="comment">/* 0x80 is reserved and cannot be set! */</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lyxml_elem</span> *<span class="title">parent</span>;</span>       <span class="comment">/**&lt; parent node */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lyxml_attr</span> *<span class="title">attr</span>;</span>         <span class="comment">/**&lt; first attribute declared in the element */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lyxml_elem</span> *<span class="title">child</span>;</span>        <span class="comment">/**&lt; first children element */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lyxml_elem</span> *<span class="title">next</span>;</span>         <span class="comment">/**&lt; next sibling node */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lyxml_elem</span> *<span class="title">prev</span>;</span>         <span class="comment">/**&lt; previous sibling node */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;                <span class="comment">/**&lt; name of the element */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">lyxml_ns</span> *<span class="title">ns</span>;</span>       <span class="comment">/**&lt; namespace of the element */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *content;             <span class="comment">/**&lt; text content of the node if any */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="解析的过程"><a href="#解析的过程" class="headerlink" title="解析的过程"></a>解析的过程</h3><p><code>in file libnetconf2/src/io.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">worker_thread(<span class="keyword">void</span> *arg)</span><br><span class="line">    <span class="comment">/* listen for incoming requests on active NETCONF sessions */</span></span><br><span class="line">    rc = nc_ps_poll(np2srv.nc_ps, <span class="number">0</span>, &amp;ncs);</span><br><span class="line">        nc_ps_poll_session_io(cur_session, NC_SESSION_LOCK_TIMEOUT, ts_cur.tv_sec, msg);</span><br><span class="line">        nc_server_recv_rpc_io(cur_session, timeout, &amp;rpc);</span><br><span class="line">			msgtype = nc_read_msg_io(session, io_timeout, &amp;xml, <span class="number">0</span>);</span><br><span class="line">				<span class="comment">/* build XML tree */</span></span><br><span class="line">                *data = lyxml_parse_mem(session-&gt;ctx, msg, <span class="number">0</span>);</span><br><span class="line">					<span class="comment">/* 具体看代码*/</span></span><br><span class="line">					root = lyxml_parse_elem(ctx, c, &amp;len, <span class="literal">NULL</span>, options);</span><br></pre></td></tr></table></figure>

<h3 id="rpc对比"><a href="#rpc对比" class="headerlink" title="rpc对比"></a>rpc对比</h3><h4 id="clixon"><a href="#clixon" class="headerlink" title="clixon"></a>clixon</h4><ul>
<li>clixon项目中没有使用query选项！！！</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//代码生成rpc的部分，在cixon/lib/src/clixon_proto_client.c/clicon_rpc_get(h, path, &amp;xret)</span></span><br><span class="line"><span class="keyword">if</span> ((cb = cbuf_new()) == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">goto</span> done;</span><br><span class="line">cprintf(cb, <span class="string">"&lt;rpc"</span>);</span><br><span class="line"><span class="keyword">if</span> ((username = clicon_username_get(h)) != <span class="literal">NULL</span>)</span><br><span class="line">cprintf(cb, <span class="string">" username=\"%s\""</span>, username);</span><br><span class="line">cprintf(cb, <span class="string">"&gt;&lt;get&gt;"</span>);</span><br><span class="line"><span class="keyword">if</span> (xpath &amp;&amp; <span class="built_in">strlen</span>(xpath))</span><br><span class="line">cprintf(cb, <span class="string">"&lt;filter type=\"xpath\" select=\"%s\"/&gt;"</span>, xpath);</span><br><span class="line">cprintf(cb, <span class="string">"&lt;/get&gt;&lt;/rpc&gt;"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对于这个get的rpc例子，其中填写的只有select的选项，填写的内容是xpath，我这里因为请求/restconf/data所以相当于是根目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// log记录的样子</span></span><br><span class="line">clicon_rpc_msg request:&lt;rpc username=<span class="string">"none"</span>&gt;&lt;get&gt;&lt;filter type=<span class="string">"xpath"</span> select=<span class="string">"/"</span>/&gt;&lt;/get&gt;&lt;/rpc&gt;</span><br></pre></td></tr></table></figure>

<h4 id="netopeer2"><a href="#netopeer2" class="headerlink" title="netopeer2"></a>netopeer2</h4><h5 id="相关数据结构"><a href="#相关数据结构" class="headerlink" title="相关数据结构"></a>相关数据结构</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义在libnetconf2/src/messages_client.h里面</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief Enumeration of RPC types</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note that NC_RPC_CLOSE is not defined since sending \&lt;close-session\&gt; is done implicitly by nc_session_free()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</span><br><span class="line">    NC_RPC_UNKNOWN = <span class="number">0</span>, <span class="comment">/**&lt; invalid RPC. */</span></span><br><span class="line">    NC_RPC_ACT_GENERIC, <span class="comment">/**&lt; user-defined generic RPC/action. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ietf-netconf */</span></span><br><span class="line">    NC_RPC_GETCONFIG,   <span class="comment">/**&lt; \&lt;get-config\&gt; RPC. */</span></span><br><span class="line">    NC_RPC_EDIT,        <span class="comment">/**&lt; \&lt;edit-config\&gt; RPC. */</span></span><br><span class="line">    NC_RPC_COPY,        <span class="comment">/**&lt; \&lt;copy-config\&gt; RPC. */</span></span><br><span class="line">    NC_RPC_DELETE,      <span class="comment">/**&lt; \&lt;delete-config\&gt; RPC. */</span></span><br><span class="line">    NC_RPC_LOCK,        <span class="comment">/**&lt; \&lt;lock\&gt; RPC. */</span></span><br><span class="line">    NC_RPC_UNLOCK,      <span class="comment">/**&lt; \&lt;unlock\&gt; RPC. */</span></span><br><span class="line">    NC_RPC_GET,         <span class="comment">/**&lt; \&lt;get\&gt; RPC. */</span></span><br><span class="line">    NC_RPC_KILL,        <span class="comment">/**&lt; \&lt;kill-session\&gt; RPC. */</span></span><br><span class="line">    NC_RPC_COMMIT,      <span class="comment">/**&lt; \&lt;commit\&gt; RPC. */</span></span><br><span class="line">    NC_RPC_DISCARD,     <span class="comment">/**&lt; \&lt;discard-changes\&gt; RPC. */</span></span><br><span class="line">    NC_RPC_CANCEL,      <span class="comment">/**&lt; \&lt;cancel-commit\&gt; RPC. */</span></span><br><span class="line">    NC_RPC_VALIDATE,    <span class="comment">/**&lt; \&lt;validate\&gt; RPC. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ietf-netconf-monitoring */</span></span><br><span class="line">    NC_RPC_GETSCHEMA,   <span class="comment">/**&lt; \&lt;get-schema\&gt; RPC. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* notifications */</span></span><br><span class="line">    NC_RPC_SUBSCRIBE    <span class="comment">/**&lt; \&lt;create-subscription\&gt; RPC. */</span></span><br><span class="line">&#125; NC_RPC_TYPE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义在libnetconf2/src/messages_p.h里面</span></span><br><span class="line"><span class="comment">// 这样的架构的目的是，有一个通用的nc_rpc类型，对应到具体类型的时候进行类型转换，有点cpp的子类的意思，应该是c里面的一种模拟</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nc_rpc</span> &#123;</span></span><br><span class="line">    NC_RPC_TYPE type;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nc_rpc_get</span> &#123;</span></span><br><span class="line">    NC_RPC_TYPE type;        <span class="comment">/**&lt; NC_RPC_GET */</span></span><br><span class="line">    <span class="keyword">char</span> *filter;            <span class="comment">/**&lt; either XML subtree (starts with '&lt;') or an XPath (starts with '/' or an alpha) */</span></span><br><span class="line">    NC_WD_MODE wd_mode;</span><br><span class="line">    <span class="keyword">char</span> <span class="built_in">free</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nc_rpc_edit</span> &#123;</span></span><br><span class="line">    NC_RPC_TYPE type;        <span class="comment">/**&lt; NC_RPC_EDIT */</span></span><br><span class="line">    NC_DATASTORE target;</span><br><span class="line">    NC_RPC_EDIT_DFLTOP default_op;</span><br><span class="line">    NC_RPC_EDIT_TESTOPT test_opt;</span><br><span class="line">    NC_RPC_EDIT_ERROPT error_opt;</span><br><span class="line">    <span class="keyword">char</span> *edit_cont;         <span class="comment">/**&lt; either URL (starts with aplha) or config (starts with '&lt;') */</span></span><br><span class="line">    <span class="keyword">char</span> <span class="built_in">free</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="cli"><a href="#cli" class="headerlink" title="cli"></a>cli</h5><ul>
<li><code>struct nc_rpc rpc</code> -&gt; <code>lyd_node data</code> -&gt; send from cli to server</li>
<li>&lt;rpc&gt; -&gt; <code>lyxml_elem</code> -&gt; <code>lyd_node</code> (using <code>lyd_parse_xml</code>)</li>
<li></li>
<li>or maybe we can use <code>lyd_parse_mem</code> to do parsing job directly. </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 产生rpc 此时返回到一个struct nc_rpc 的对象，值得注意的是，在这个nc_rpc_get函数内部是用 struct nc_rpc_get 这个具体的rpc格式，然后返回的时候又退化为了通用形式，（后续会再从这个通用形式转化到具体形式）</span></span><br><span class="line"><span class="comment">// 这里的filter已经保存了cli输入的--filter-xpath 后面跟着的内容，是 char*</span></span><br><span class="line">rpc = nc_rpc_get(filter, wd, NC_PARAMTYPE_CONST);</span><br><span class="line"><span class="comment">// 使用这个对象进行发送</span></span><br><span class="line">ret = cli_send_recv(rpc, output, wd);</span><br><span class="line">	<span class="comment">// 具体是这个函数</span></span><br><span class="line">	msgtype = nc_send_rpc(session, rpc, <span class="number">1000</span>, &amp;msgid);</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更详细的，是上面那个函数内部的switch case</span></span><br><span class="line"><span class="comment">/* 这是一个rpc例子</span></span><br><span class="line"><span class="comment">&lt;rpc xmlns=\"urn:ietf:params:xml:ns:netconf:base:1.0\" message-id=\"39\"&gt;</span></span><br><span class="line"><span class="comment">    &lt;get xmlns=\"urn:ietf:params:xml:ns:netconf:base:1.0\"&gt;</span></span><br><span class="line"><span class="comment">		&lt;filter type=\"xpath\" xmlns:bld=\"urn:building:test\" </span></span><br><span class="line"><span class="comment">				select=\"/bld:*\"/&gt;</span></span><br><span class="line"><span class="comment">    &lt;/get&gt;</span></span><br><span class="line"><span class="comment">&lt;/rpc&gt;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/* 所以说，看完了这个部分我们可以意识到：</span></span><br><span class="line"><span class="comment">	- 一个data node节点包含&lt;name xmlns="namespace"&gt;，这里的namespace是在创建node的时候指定的</span></span><br><span class="line"><span class="comment">	- 可以向node里面插入attribute，会在node里面产生 attr=xxx的一段</span></span><br><span class="line"><span class="comment">	一个问题：我创建filter的时候使用的namespace是ietf-netconf，为什么之后变成了urn:building:test，而且，前面的标志是xmlns:bld带了prefix*/</span></span><br><span class="line"><span class="keyword">case</span> NC_RPC_GET:</span><br><span class="line">rpc_g = (struct nc_rpc_get *)rpc; <span class="comment">// 将之前产生的rpc对象转换到特定的方式的struct(这里是get)</span></span><br><span class="line"><span class="comment">/* 新建一个lyd_node, 使用的lys_module是ietf-netconf, name是schema node name*/</span></span><br><span class="line">data = lyd_new(<span class="literal">NULL</span>, ietfnc, <span class="string">"get"</span>);	</span><br><span class="line"><span class="keyword">if</span> (rpc_g-&gt;filter) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!rpc_g-&gt;filter[<span class="number">0</span>] || (rpc_g-&gt;filter[<span class="number">0</span>] == <span class="string">'&lt;'</span>)) &#123;</span><br><span class="line">        node = lyd_new_anydata(data, ietfnc, <span class="string">"filter"</span>, rpc_g-&gt;filter, LYD_ANYDATA_SXML);</span><br><span class="line">        lyd_insert_attr(node, <span class="literal">NULL</span>, <span class="string">"type"</span>, <span class="string">"subtree"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* 我们用xpath，首先新建一个anydata的data node，</span></span><br><span class="line"><span class="comment">        		name是filter，不往里面填东西，类型conststring */</span></span><br><span class="line">        node = lyd_new_anydata(data, ietfnc, <span class="string">"filter"</span>, <span class="literal">NULL</span>, LYD_ANYDATA_CONSTSTRING);</span><br><span class="line">        <span class="comment">/* 往里面插入两个attribute*/</span></span><br><span class="line">        lyd_insert_attr(node, <span class="literal">NULL</span>, <span class="string">"type"</span>, <span class="string">"xpath"</span>);</span><br><span class="line">        lyd_insert_attr(node, <span class="literal">NULL</span>, <span class="string">"select"</span>, rpc_g-&gt;filter);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!node) &#123;</span><br><span class="line">        lyd_free(data);</span><br><span class="line">        <span class="keyword">return</span> NC_MSG_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 经过上述的步骤生成的lyd_node gdb debug信息：</span></span><br><span class="line"><span class="comment">// 经过对比，和server解析后的结果的唯一差异就只是server解析后的填写了priv字段</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">(gdb) p *data</span></span><br><span class="line"><span class="comment">$10 = &#123;schema = 0x697440, validity = 0 '\000', dflt = 0 '\000', when_status = 0 '\000', </span></span><br><span class="line"><span class="comment">  attr = 0x0, next = 0x0, prev = 0x6927d0, parent = 0x0, hash = 1772939101, ht = 0x0, </span></span><br><span class="line"><span class="comment">  child = 0x691420&#125;</span></span><br><span class="line"><span class="comment">(gdb) p *data </span></span><br><span class="line"><span class="comment">$11 = &#123;name = 0x6717a0 "get", </span></span><br><span class="line"><span class="comment">  dsc = 0x685800 "Retrieve running configuration and device state information.", </span></span><br><span class="line"><span class="comment">  ref = 0x670ed0 "RFC 6241, Section 7.7", flags = 0, ext_size = 0 '\000', </span></span><br><span class="line"><span class="comment">  iffeature_size = 0 '\000', padding = "\000\000\000", ext = 0x0, iffeature = 0x0, </span></span><br><span class="line"><span class="comment">  module = 0x689150, nodetype = LYS_RPC, parent = 0x0, child = 0x6975c0, </span></span><br><span class="line"><span class="comment">  next = 0x697540, prev = 0x68e460, priv = 0x0, hash = "\000\000\000"&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/* 经lyd_validate以后，lyd_node的validty字段会变成'\000'*/</span></span><br><span class="line">lyd_validate(&amp;data,...)</span><br><span class="line"><span class="comment">/* send RPC, store its message ID 到这里，rpc已经转化到了lyd_node类型的data里面*/</span></span><br><span class="line">r = nc_send_msg_io(session, timeout, data);</span><br><span class="line">	nc_write_msg_io(session, io_timeout, NC_MSG_RPC, op, <span class="literal">NULL</span>); <span class="comment">//data输入到op</span></span><br><span class="line">		<span class="comment">/* 下面是经过switch case选中的NC_MSG_RPC */</span></span><br><span class="line">        content = va_arg(ap, struct lyd_node *);</span><br><span class="line">        attrs = va_arg(ap, <span class="keyword">const</span> <span class="keyword">char</span> *); <span class="comment">// 这个是空的（对于测试样例）</span></span><br><span class="line">		<span class="comment">/* rpc头部，先经过buf转了一下*/</span></span><br><span class="line">        count = asprintf(&amp;buf, <span class="string">"&lt;rpc xmlns=\"%s\" message-id=\"%"</span>PRIu64<span class="string">"\"%s&gt;"</span>,</span><br><span class="line">                         NC_NS_BASE, session-&gt;opts.client.msgid + <span class="number">1</span>, attrs ? attrs : <span class="string">""</span>);</span><br><span class="line">		<span class="keyword">if</span> (count == <span class="number">-1</span>) &#123;</span><br><span class="line">            ERRMEM;</span><br><span class="line">            ret = NC_MSG_ERROR;</span><br><span class="line">            <span class="keyword">goto</span> cleanup;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* 把头部的内容发出去 */</span></span><br><span class="line">		nc_write_clb((<span class="keyword">void</span> *)&amp;arg, buf, count, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">free</span>(buf);</span><br><span class="line">		<span class="comment">/* 调用libyang的函数把lyd_node输出xml形式，发送 */</span></span><br><span class="line">        <span class="keyword">if</span> (lyd_print_clb(nc_write_xmlclb, (<span class="keyword">void</span> *)&amp;arg, content, LYD_XML, 			 		 			LYP_WITHSIBLINGS | LYP_NETCONF)) &#123;</span><br><span class="line">            ret = NC_MSG_ERROR;</span><br><span class="line">            <span class="keyword">goto</span> cleanup;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* 把尾部的内容发出去 */</span></span><br><span class="line">        nc_write_clb((<span class="keyword">void</span> *)&amp;arg, <span class="string">"&lt;/rpc&gt;"</span>, <span class="number">6</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<h5 id="server"><a href="#server" class="headerlink" title="server"></a>server</h5><p>简要的，这里解析的时候首先将xml格式的rpc解析到<code>lyxml_elem</code>，再解析到<code>lyd_node</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">worker_thread(<span class="keyword">void</span> *arg)</span><br><span class="line">    <span class="comment">/* listen for incoming requests on active NETCONF sessions */</span></span><br><span class="line">    rc = nc_ps_poll(np2srv.nc_ps, <span class="number">0</span>, &amp;ncs);</span><br><span class="line">		ret = nc_ps_poll_session_io(cur_session, NC_SESSION_LOCK_TIMEOUT, </span><br><span class="line">                                    ts_cur.tv_sec, msg);</span><br><span class="line">			ret = nc_server_recv_rpc_io(cur_session, timeout, &amp;rpc);</span><br><span class="line">				msgtype = nc_read_msg_io(session, io_timeout, &amp;xml, <span class="number">0</span>);</span><br><span class="line">					*data = lyxml_parse_mem(session-&gt;ctx, msg, <span class="number">0</span>);</span><br><span class="line"><span class="comment">/* 想要rpc 把断点打在 lyxml_parse_mem*/</span></span><br><span class="line"><span class="comment">/* $3 = 0x7fffd4007c50 "</span></span><br><span class="line"><span class="comment">&lt;rpc xmlns=\"urn:ietf:params:xml:ns:netconf:base:1.0\" message-id=\"39\"&gt;</span></span><br><span class="line"><span class="comment">    &lt;get xmlns=\"urn:ietf:params:xml:ns:netconf:base:1.0\"&gt;</span></span><br><span class="line"><span class="comment">		&lt;filter type=\"xpath\" xmlns:bld=\"urn:building:test\" </span></span><br><span class="line"><span class="comment">				select=\"/bld:*\"/&gt;</span></span><br><span class="line"><span class="comment">    &lt;/get&gt;</span></span><br><span class="line"><span class="comment">&lt;/rpc&gt;"...</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">				(*rpc)-&gt;tree = lyd_parse_xml(server_opts.ctx, &amp;xml-&gt;child,</span><br><span class="line">                                     LYD_OPT_RPC | LYD_OPT_DESTRUCT | LYD_OPT_NOEXTDEPS |</span><br><span class="line">                                     LYD_OPT_STRICT, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 上述netopeer2测试的例子的building.yang</span></span><br><span class="line"><span class="comment"># 可以见到，select="bld:\" 选中的是prefix</span></span><br><span class="line">module building &#123;</span><br><span class="line">  yang-version 1;</span><br><span class="line">  namespace <span class="string">"urn:building:test"</span>;</span><br><span class="line"></span><br><span class="line">  prefix bld;</span><br><span class="line"></span><br><span class="line">  organization <span class="string">"building"</span>;</span><br><span class="line">  contact <span class="string">"building address"</span>;</span><br><span class="line">  description <span class="string">"yang model for buildings"</span>;</span><br><span class="line">  revision <span class="string">"2018-01-22"</span> &#123;</span><br><span class="line">    description <span class="string">"initial revision"</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  container rooms &#123;</span><br><span class="line">    list room &#123;</span><br><span class="line">      key room-number;</span><br><span class="line">      leaf room-number &#123;</span><br><span class="line">        <span class="built_in">type</span> uint16;</span><br><span class="line">      &#125;</span><br><span class="line">      leaf size &#123;</span><br><span class="line">        <span class="built_in">type</span> uint32;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="initiate"><a href="#initiate" class="headerlink" title="initiate"></a>initiate</h3><ul>
<li>monitor是什么<ul>
<li><em>netconf_monitoring.c</em>, <em>@brief netopeer2-server ietf-netconf-monitoring statistics and counters</em></li>
<li>restconf  和 netconf在monitoring上差异怎么解决</li>
<li>capability的初始化设定</li>
</ul>
</li>
<li>poll session?</li>
<li>capability是什么</li>
<li>加载yang module做的事情<ul>
<li>sysrepo订阅<code>np2srv_sr_subtree_change_subscribe</code> </li>
<li>feature <code>feature_change_ietf_system(np2srv.sr_sess.srs, &quot;local-users&quot;, 1)</code></li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">server_init(<span class="keyword">void</span>)</span><br><span class="line">    <span class="comment">// connect sysrepo </span></span><br><span class="line">    rc = sr_connect(<span class="string">"netopeer2"</span>, SR_CONN_DAEMON_REQUIRED | </span><br><span class="line">                    SR_CONN_DAEMON_START, &amp;np2srv.sr_conn);</span><br><span class="line">	rc = sr_session_start(np2srv.sr_conn, np2srv.sr_sess.ds, </span><br><span class="line">                          np2srv.sr_sess.opts, &amp;np2srv.sr_sess.srs);</span><br><span class="line">	<span class="comment">/* init libyang context with schemas */</span></span><br><span class="line">    <span class="keyword">if</span> (np2srv_init_schemas()) &#123;</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* init monitoring */</span></span><br><span class="line">    ncm_init();</span><br><span class="line">		stats.netconf_start_time = time(<span class="literal">NULL</span>);</span><br><span class="line">        pthread_mutex_init(&amp;stats.lock, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* init libnetconf2 */</span></span><br><span class="line">    nc_server_init(np2srv.ly_ctx);</span><br><span class="line">		nc_init();</span><br><span class="line">		<span class="comment">/* set default &lt;get-schema&gt; callback if not specified */</span></span><br><span class="line">        rpc = ly_ctx_get_node(ctx, <span class="literal">NULL</span>, <span class="string">"/ietf-netconf-monitoring:get-schema"</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (rpc &amp;&amp; !rpc-&gt;priv) &#123;</span><br><span class="line">            lys_set_private(rpc, nc_clb_default_get_schema);</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">/* set default &lt;close-session&gt; callback if not specififed */</span></span><br><span class="line">        rpc = ly_ctx_get_node(ctx, <span class="literal">NULL</span>, <span class="string">"/ietf-netconf:close-session"</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="comment">/* ... */</span></span><br><span class="line">		</span><br><span class="line">	<span class="comment">/* prepare poll session structure for libnetconf2 */</span></span><br><span class="line">    np2srv.nc_ps = nc_ps_new();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* set with-defaults capability basic-mode */</span></span><br><span class="line">    nc_server_set_capab_withdefaults(NC_WD_EXPLICIT, NC_WD_ALL | NC_WD_ALL_TAG | NC_WD_TRIM | NC_WD_EXPLICIT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* set capabilities for the NETCONF Notifications */</span></span><br><span class="line">    nc_server_set_capability(<span class="string">"urn:ietf:params:netconf:capability:notification:1.0"</span>);</span><br><span class="line">    nc_server_set_capability(<span class="string">"urn:ietf:params:netconf:capability:interleave:1.0"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* set NETCONF operations callbacks */</span></span><br><span class="line">    snode = ly_ctx_get_node(np2srv.ly_ctx, <span class="literal">NULL</span>, <span class="string">"/ietf-netconf:get-config"</span>, <span class="number">0</span>);</span><br><span class="line">    nc_set_rpc_callback(snode, op_get);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* set Notifications subscription callback */</span></span><br><span class="line">    snode = ly_ctx_get_node(np2srv.ly_ctx, <span class="literal">NULL</span>, <span class="string">"/notifications:create-subscription"</span>, <span class="number">0</span>);</span><br><span class="line">    nc_set_rpc_callback(snode, op_ntf_subscribe);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* set server options */</span></span><br><span class="line">    mod = ly_ctx_get_module(np2srv.ly_ctx, <span class="string">"ietf-netconf-server"</span>, <span class="literal">NULL</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (mod &amp;&amp; <span class="built_in">strcmp</span>(NP2SRV_KEYSTORED_DIR, <span class="string">"none"</span>)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (ietf_netconf_server_init(mod)) &#123;</span><br><span class="line">            <span class="keyword">goto</span> error;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mod = ly_ctx_get_module(np2srv.ly_ctx, <span class="string">"ietf-system"</span>, <span class="literal">NULL</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (mod) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ietf_system_init(mod)) &#123;</span><br><span class="line">                <span class="keyword">goto</span> error;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            WRN(<span class="string">"Sysrepo does not implement the \"ietf-system\" module, SSH publickey authentication will not work."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        WRN(<span class="string">"Sysrepo does not have the \"ietf-netconf-server\" module or keystored keys dir unknown, using default NETCONF server options."</span>);</span><br><span class="line">        nc_server_ssh_set_hostkey_clb(np2srv_default_hostkey_clb, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (nc_server_add_endpt(<span class="string">"main"</span>, NC_TI_LIBSSH)) &#123;</span><br><span class="line">            <span class="keyword">goto</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (nc_server_endpt_set_address(<span class="string">"main"</span>, <span class="string">"0.0.0.0"</span>)) &#123;</span><br><span class="line">            <span class="keyword">goto</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (nc_server_endpt_set_port(<span class="string">"main"</span>, <span class="number">830</span>)) &#123;</span><br><span class="line">            <span class="keyword">goto</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (nc_server_ssh_endpt_add_hostkey(<span class="string">"main"</span>, <span class="string">"default"</span>, <span class="number">-1</span>)) &#123;</span><br><span class="line">            <span class="keyword">goto</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="POST-实现"><a href="#POST-实现" class="headerlink" title="POST 实现"></a>POST 实现</h3><h4 id="restconf"><a href="#restconf" class="headerlink" title="restconf"></a>restconf</h4><ul>
<li>没有datastore的概念</li>
<li>clixon流程：<ul>
<li>edit-config: target = candidate; default-operation = none</li>
<li>commit</li>
<li>if netopeer have startup feature<ul>
<li>copy-config to startup</li>
</ul>
</li>
</ul>
</li>
<li>一个比较重要的差别：对比netopeer2的edit-config，restconf在url里面可能存在部分路径（datastore 与 data resource的区别。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">edit-config [--<span class="built_in">help</span>] --target running|candidate (--config[=&lt;file&gt;] | --url &lt;url&gt;) [--defop merge|replace|none] [--<span class="built_in">test</span> <span class="built_in">set</span>|<span class="built_in">test</span>-only|<span class="built_in">test</span>-then-set] [--error stop|<span class="built_in">continue</span>|rollback]</span><br></pre></td></tr></table></figure>

<h4 id="netconf-edit-config"><a href="#netconf-edit-config" class="headerlink" title="netconf: edit-config"></a>netconf: edit-config</h4><ul>
<li><p>operation: Elements in the &lt;config&gt; subtree <strong>MAY</strong> contain an “operation” attribute, which belongs to the NETCONF namespace</p>
</li>
<li><p>netconf 里面定义<strong>attribute</strong>的operation = merge | replace | create | delete | remove </p>
<ul>
<li>在yang里面只定义了typedef edit-operation-type {，没看到使用啊 – 这个还是不知道</li>
<li>为什么说 belongs to the NETCONF namespace? – 这个可以回答了，看下面的data的xml需要指定nc</li>
<li><code>&lt;interface xc:operation=&quot;replace&quot;&gt;</code></li>
<li>A: 感觉这个attribute是自己写的，需要执行的时候自己加上去，写在顶级?node里面</li>
<li>AA：前半句对，是自己写的，但是这个是在发送的config里面写的。=，写法如下：</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># delete test</span></span><br><span class="line">&lt;rooms xmlns=<span class="string">"urn:building:test"</span> xmlns:nc=<span class="string">"urn:ietf:params:xml:ns:netconf:base:1.0"</span>&gt;</span><br><span class="line">  &lt;room nc:operation=<span class="string">"delete"</span>&gt;</span><br><span class="line">    &lt;room-number&gt;12&lt;/room-number&gt;</span><br><span class="line">    &lt;room-name&gt;dabc&lt;/room-name&gt;</span><br><span class="line">  &lt;/room&gt;</span><br><span class="line">&lt;/rooms&gt;</span><br><span class="line"><span class="comment"># 这里的一个注意点是要在前面定义nc： xmlns:nc="urn:ietf:params:xml:ns:netconf:base:1.0"</span></span><br><span class="line"><span class="comment"># 否则会报错如下，原因是不定义这个nc，解析的时候不知道是谁的operation</span></span><br><span class="line">&gt; edit-config --target running --config</span><br><span class="line">ERROR</span><br><span class="line">	<span class="built_in">type</span>:     protocol</span><br><span class="line">	tag:      unknown-attribute</span><br><span class="line">	severity: error</span><br><span class="line">	message:  Invalid attribute <span class="string">"operation"</span>.</span><br><span class="line">	bad-attr <span class="comment">#1: operation</span></span><br><span class="line">	bad-elem <span class="comment">#1: /building:rooms/room</span></span><br><span class="line">	</span><br><span class="line"><span class="comment"># netopeer2</span></span><br><span class="line">(gdb) p *sessions-&gt;srs</span><br><span class="line"><span class="variable">$44</span> = &#123;conn_ctx = 0x6492d0, id = 1891619541, lock = &#123;__data = &#123;__lock = 0, __count = 0, __</span><br><span class="line">owner = 0, __nusers = 0, __kind = 0, __spins = 0, __elision = 0, __list = &#123;__prev = 0x0, _</span><br><span class="line">_next = 0x0&#125;&#125;, __size = <span class="string">'\000'</span> &lt;repeats 39 <span class="built_in">times</span>&gt;, __align = 0&#125;, last_error = SR_ERR_OK, e</span><br><span class="line">rror_info = 0x0, error_info_size = 0, error_cnt = 0, notif_session = <span class="literal">false</span>, commit_id = 0&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p data</span><br><span class="line">$7 = 0x725ea0 "</span><br><span class="line"><span class="tag">&lt;<span class="name">rpc</span> <span class="attr">xmlns</span>=<span class="string">\</span>"<span class="attr">urn:ietf:params:xml:ns:netconf:base:1.0</span>\" <span class="attr">message-id</span>=<span class="string">\</span>"<span class="attr">22</span>\"&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">edit-config</span> <span class="attr">xmlns</span>=<span class="string">\</span>"<span class="attr">urn:ietf:params:xml:ns:netconf:base:1.0</span>\"&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">target</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">running</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">config</span>&gt;</span>// config 里面是我提交的部分</span><br><span class="line">            <span class="tag">&lt;<span class="name">rooms</span> <span class="attr">xmlns</span>=<span class="string">\</span>"<span class="attr">urn:building:test</span>\"&gt;</span>\n  </span><br><span class="line">                <span class="tag">&lt;<span class="name">room</span>&gt;</span>\n    </span><br><span class="line">                    <span class="tag">&lt;<span class="name">room-number</span>&gt;</span>2&gt;<span class="tag">&lt;/<span class="name">room-number</span>&gt;</span>\n    </span><br><span class="line">                    <span class="tag">&lt;<span class="name">room-name</span>&gt;</span>abcd<span class="tag">&lt;/<span class="name">room-name</span>&gt;</span>\n    </span><br><span class="line">                    <span class="tag">&lt;<span class="name">size</span>&gt;</span>100<span class="tag">&lt;/<span class="name">size</span>&gt;</span>\n  </span><br><span class="line">                <span class="tag">&lt;/<span class="name">room</span>&gt;</span>\n</span><br><span class="line">            <span class="tag">&lt;/<span class="name">rooms</span>&gt;</span>\n</span><br><span class="line">        <span class="tag">&lt;/<span class="name">config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">edit-config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rpc</span>&gt;</span>"</span><br></pre></td></tr></table></figure>

<h4 id="implement"><a href="#implement" class="headerlink" title="implement"></a>implement</h4><ul>
<li>现在实现的是把url中的部分路径转换到data里面，但是我担忧理解可能有偏差，因为协议讲的是If the target resource type is a datastore or data resource, then the POST is treated as a request to create a <strong>top-level resource</strong> or child resource, respectively. </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># datastore</span></span><br><span class="line">curl -s -i -X POST -H <span class="string">"Accept: application/yang-data+xml"</span> -d <span class="string">'&lt;rooms xmlns="urn:building:test"&gt;&lt;room&gt;&lt;room-number&gt;2333&lt;/room-number&gt;&lt;room-name&gt;deabc&lt;/room-name&gt;&lt;size&gt;100&lt;/size&gt;&lt;/room&gt;&lt;/rooms&gt;'</span> http://localhost/restconf/data</span><br><span class="line"><span class="comment"># json</span></span><br><span class="line">curl -s -i -X POST -H <span class="string">"Accept: application/yang-data+json"</span> -d <span class="string">'&#123;"building:rooms":&#123;"room": [&#123;"room-number":2333,"room-name":"deabc","size":100&#125;]&#125;&#125;'</span> http://localhost/restconf/data</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"building:rooms"</span>:&#123;</span><br><span class="line">		<span class="string">"room"</span>: [&#123;</span><br><span class="line">			<span class="string">"room-number"</span>:2333,</span><br><span class="line">            <span class="string">"room-name"</span>:<span class="string">"deabc"</span>,</span><br><span class="line">            <span class="string">"size"</span>:100</span><br><span class="line">        &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;<span class="string">"building:rooms"</span>:&#123;<span class="string">"room"</span>: [&#123;<span class="string">"room-number"</span>:2333,<span class="string">"room-name"</span>:<span class="string">"deabc"</span>,<span class="string">"size"</span>:100&#125;]&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># data resource</span></span><br><span class="line"><span class="comment"># 有部分路径在url里面</span></span><br><span class="line">curl -s -i -X POST -H <span class="string">"Accept: application/yang-data+xml"</span> -d <span class="string">'&lt;room xmlns="urn:building:test"&gt;&lt;room-number&gt;2333&lt;/room-number&gt;&lt;room-name&gt;deabc&lt;/room-name&gt;&lt;size&gt;100&lt;/size&gt;&lt;/room&gt;'</span> http://localhost/restconf/data/building:rooms</span><br><span class="line"><span class="comment"># json</span></span><br><span class="line">curl -s -i -X POST -H <span class="string">"Accept: application/yang-data+json"</span> -d <span class="string">'&#123;"building:room": [&#123;"room-number":2333,"room-name":"deabc","size":100&#125;]&#125;'</span> http://localhost/restconf/data/building:rooms</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也就是说，我需要利用/building:rooms 去生成&lt;rooms xmlns="urn:building:test"&gt;&lt;/rooms&gt;</span></span><br><span class="line"><span class="comment"># 并且与原始的data信息拼装成完整的</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 多级container测试</span></span><br><span class="line">curl -s -i -X POST -H <span class="string">"Accept: application/yang-data+xml"</span> -d <span class="string">'&lt;storages xmlns="urn:building:test"&gt;&lt;boxs&gt;&lt;toys&gt;&lt;toy-number&gt;1&lt;/toy-number&gt;&lt;toy-owner&gt;tom&lt;/toy-owner&gt;&lt;/toys&gt;&lt;/boxs&gt;&lt;/storages&gt;'</span> http://localhost/restconf/data/</span><br><span class="line"></span><br><span class="line">curl -s -i -X POST -H <span class="string">"Accept: application/yang-data+xml"</span> -d <span class="string">'&lt;toys xmlns="urn:building:test"&gt;&lt;toy-number&gt;1&lt;/toy-number&gt;&lt;toy-owner&gt;tom&lt;/toy-owner&gt;&lt;/toys&gt;'</span> http://localhost/restconf/data/building:storages/boxs</span><br><span class="line"></span><br><span class="line"><span class="comment"># jukebox test for multi-key</span></span><br><span class="line"><span class="comment"># datastore</span></span><br><span class="line">curl -s -i -X POST -H <span class="string">"Accept: application/yang-data+xml"</span> -d <span class="string">'&lt;jukebox xmlns="http://example.com/ns/example-jukebox"&gt;&lt;library&gt;&lt;artist&gt;&lt;name&gt;Foo Fighters&lt;/name&gt;&lt;album&gt;&lt;name&gt;One by One&lt;/name&gt;&lt;year&gt;2012&lt;/year&gt;&lt;song&gt;&lt;name&gt;song1&lt;/name&gt;&lt;location&gt;/home/music&lt;/location&gt;&lt;format&gt;MP3&lt;/format&gt;&lt;length&gt;286&lt;/length&gt;&lt;/song&gt;&lt;/album&gt;&lt;/artist&gt;&lt;/library&gt;&lt;/jukebox&gt;'</span> http://localhost/restconf/data</span><br><span class="line"></span><br><span class="line"><span class="comment"># data resource </span></span><br><span class="line">curl -s -i -X POST -H <span class="string">"Accept: application/yang-data+xml"</span> -d <span class="string">'&lt;song xmlns="http://example.com/ns/example-jukebox"&gt;&lt;name&gt;song1&lt;/name&gt;&lt;location&gt;music&lt;/location&gt;&lt;format&gt;MP3&lt;/format&gt;&lt;length&gt;286&lt;/length&gt;&lt;/song&gt;'</span>  http://localhost/restconf/data/example-jukebox:jukebox/library/artist=Foo%20Fighters/album=Wasting%20Light</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;jukebox xmlns=<span class="string">"http://example.com/ns/example-jukebox"</span>&gt;</span><br><span class="line">  &lt;library&gt;</span><br><span class="line">    &lt;artist&gt;</span><br><span class="line">      &lt;name&gt;Foo Fighters&lt;/name&gt;</span><br><span class="line">      &lt;album&gt;</span><br><span class="line">        &lt;name&gt;One by One&lt;/name&gt;</span><br><span class="line">        &lt;year&gt;2012&lt;/year&gt;</span><br><span class="line">        &lt;song&gt;</span><br><span class="line">        	&lt;name&gt;song1&lt;/name&gt;</span><br><span class="line">        	&lt;location&gt;/home/music&lt;/location&gt;</span><br><span class="line">        	&lt;format&gt;MP3&lt;/format&gt;</span><br><span class="line">        	&lt;length&gt;286&lt;/length&gt;</span><br><span class="line">        &lt;/song&gt;</span><br><span class="line">      &lt;/album&gt;</span><br><span class="line">    &lt;/artist&gt;</span><br><span class="line">  &lt;/library&gt;</span><br><span class="line">&lt;/jukebox&gt;</span><br></pre></td></tr></table></figure>

<h4 id="double-POST-error"><a href="#double-POST-error" class="headerlink" title="double POST error"></a>double POST error</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这部分在netopeer2里面会报错</span></span><br><span class="line"><span class="comment"># edit 的内容是：</span></span><br><span class="line">&lt;rooms xmlns=<span class="string">"urn:building:test"</span> xmlns:nc=<span class="string">"urn:ietf:params:xml:ns:netconf:base:1.0"</span>&gt;</span><br><span class="line">  &lt;room nc:operation=<span class="string">"create"</span>&gt;</span><br><span class="line">    &lt;room-number&gt;12&lt;/room-number&gt;</span><br><span class="line">    &lt;room-name&gt;dabc&lt;/room-name&gt;</span><br><span class="line">    &lt;size&gt;200&lt;/size&gt;</span><br><span class="line">  &lt;/room&gt;</span><br><span class="line">&lt;/rooms&gt;</span><br><span class="line"></span><br><span class="line">&gt; edit-config --target running --config </span><br><span class="line">ERROR</span><br><span class="line">	<span class="built_in">type</span>:     application</span><br><span class="line">	tag:      data-exists</span><br><span class="line">	severity: error</span><br><span class="line">	path:     /building:rooms/room[room-number=<span class="string">'2333'</span>][room-name=<span class="string">'deabc'</span>]</span><br><span class="line">	message:  Request could not be completed because the relevant data model content already exists.</span><br></pre></td></tr></table></figure>

<h3 id="Coexistence-with-NETCONF"><a href="#Coexistence-with-NETCONF" class="headerlink" title="Coexistence with NETCONF"></a>Coexistence with NETCONF</h3><ul>
<li>If the NETCONF server supports <strong>:writable-running</strong>, all edits to configuration nodes in {+restconf}/data are performed in the running configuration datastore. </li>
<li>Otherwise, if the device supports <strong>:candidate</strong>, all edits to configuration nodes in {+restconf}/data are performed in the candidate configuration datastore. The candidate MUST be automatically committed to running immediately after each successful edit.</li>
<li>我当前的实现算是按照这两条来的，但是因为netconf是enable writable-running的，我猜第一条符合就忽略第二条，意味着我直接写到running里面是对的。</li>
</ul>
<h3 id="PUT"><a href="#PUT" class="headerlink" title="PUT"></a>PUT</h3><ul>
<li>在第四章开头写的PUT的对应<ul>
<li>| PUT  | &lt;copy-config&gt; (PUT on datastore)  这个奇怪的东西先不管</li>
<li>| PUT | &lt;edit-config&gt; (nc:operation=”create/replace”) 先做这个出来</li>
</ul>
</li>
<li>Both the POST and PUT methods can be used to create data resources. <ul>
<li>The difference is that for POST, the client does not provide the resource identifier for the resource that will be created. </li>
<li>The target resource for the POST method for resource creation is the parent of the new resource. </li>
<li>The target resource for the PUT method for resource creation is the new resource.</li>
</ul>
</li>
<li>提到的二者的差别是：<ul>
<li>POST只能是创建新的，target写的是新建的对象的上一级</li>
<li>PUT根据情况可能会是create / replace，原因是PUT的target写的是目标对象自己<ul>
<li>首先检测有没有这个对象，如果没有的话就对应为创建<ul>
<li>涉及到的问题：如何检测？</li>
</ul>
</li>
<li>如果有这个对象，就把已有的对象replace成新的<ul>
<li>涉及到的问题：先删再加 / 修改？ 需要看sysrepo的支持和edit-config</li>
<li>A：在edit-config里面的replace是这样做的：先删再改。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>提炼一下：PUT的对象由url确定，内容由data确定<ul>
<li>一个问题是，PUT的内容是否要求完整性？</li>
<li>感觉是不要求的，还有默认值的问题</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># replace test</span></span><br><span class="line">&lt;rooms xmlns=<span class="string">"urn:building:test"</span> xmlns:nc=<span class="string">"urn:ietf:params:xml:ns:netconf:base:1.0"</span>&gt;</span><br><span class="line">  &lt;room nc:operation=<span class="string">"replace"</span>&gt;</span><br><span class="line">    &lt;room-number&gt;12&lt;/room-number&gt;</span><br><span class="line">    &lt;room-name&gt;dabc&lt;/room-name&gt;</span><br><span class="line">    &lt;size&gt;200&lt;/size&gt;</span><br><span class="line">  &lt;/room&gt;</span><br><span class="line">&lt;/rooms&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>测试发现，对一个不存在的对象使用edit-config op=replace，是默认带创建功能的，意味着我不需要手动检测了，直接replace就行，不存在create</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PUT还可以只改一个值啊</span></span><br><span class="line"><span class="comment"># Q: 这种应该如何定位，怕把别的同级别的东西也删掉了。</span></span><br><span class="line">new <span class="string">"restconf PUT change type to eth0 (non-key sub-element to list)"</span></span><br><span class="line">expectfn <span class="string">'curl -s -X PUT -d &#123;"example:type":"eth0"&#125; http://localhost/restconf/data/example:cont1/interface=local0/type'</span> 0 <span class="string">""</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># test </span></span><br><span class="line">curl -s -i -X PUT -H <span class="string">"Accept: application/yang-data+xml"</span> -d <span class="string">'&lt;album xmlns="http://example.com/ns/example-jukebox"&gt;&lt;name&gt;Wasting Light&lt;/name&gt;&lt;year&gt;2031&lt;/year&gt;&lt;/album&gt;'</span> http://localhost/restconf/data/example-jukebox:jukebox/library/artist=Foo%20Fighters/album=Wasting%20Light</span><br><span class="line"><span class="comment"># 对比POST</span></span><br><span class="line">curl -s -i -X POST -H <span class="string">"Accept: application/yang-data+xml"</span> -d <span class="string">'&lt;song xmlns="http://example.com/ns/example-jukebox"&gt;&lt;name&gt;song1&lt;/name&gt;&lt;location&gt;music&lt;/location&gt;&lt;format&gt;MP3&lt;/format&gt;&lt;length&gt;286&lt;/length&gt;&lt;/song&gt;'</span>  http://localhost/restconf/data/example-jukebox:jukebox/library/artist=Foo%20Fighters/album=Wasting%20Light</span><br><span class="line"></span><br><span class="line"><span class="comment"># input</span></span><br><span class="line">&lt;album xmlns=<span class="string">"http://example.com/ns/example-jukebox"</span>&gt;&lt;name&gt;Wasting Light&lt;/name&gt;&lt;genre&gt;jbox:alternative&lt;/genre&gt;&lt;year&gt;2011&lt;/year&gt;&lt;/album&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 首先去掉头尾</span></span><br><span class="line">&lt;name&gt;Wasting Light&lt;/name&gt;&lt;genre&gt;jbox:alternative&lt;/genre&gt;&lt;year&gt;2011&lt;/year&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 然后根据路径补全</span></span><br><span class="line">&lt;jukebox xmlns=<span class="string">"http://example.com/ns/example-jukebox"</span>&gt;</span><br><span class="line">  &lt;library&gt;</span><br><span class="line">    &lt;artist&gt;</span><br><span class="line">      &lt;name&gt;Foo Fighters&lt;/name&gt;</span><br><span class="line">      &lt;album&gt;</span><br><span class="line">        &lt;name&gt;One by One&lt;/name&gt;</span><br><span class="line">        &lt;year&gt;2012&lt;/year&gt;</span><br><span class="line">        &lt;song&gt;</span><br><span class="line">        	&lt;name&gt;song1&lt;/name&gt;</span><br><span class="line">        	&lt;location&gt;/home/music&lt;/location&gt;</span><br><span class="line">        	&lt;format&gt;MP3&lt;/format&gt;</span><br><span class="line">        	&lt;length&gt;286&lt;/length&gt;</span><br><span class="line">        &lt;/song&gt;</span><br><span class="line">      &lt;/album&gt;</span><br><span class="line">    &lt;/artist&gt;</span><br><span class="line">  &lt;/library&gt;</span><br><span class="line">&lt;/jukebox&gt;</span><br><span class="line"></span><br><span class="line">[INF]: api_path2xml striped data: [&lt;name&gt;Wasting Light&lt;/name&gt;&lt;genre&gt;jbox:alternative&lt;/genre&gt;&lt;year&gt;2011&lt;/year&gt;]</span><br><span class="line">[INF]: api_path2xml cxml: [&lt;jukebox xmlns=<span class="string">"http://example.com/ns/example-jukebox"</span>&gt;&lt;library&gt;&lt;artist&gt;&lt;name&gt;Foo Fighters&lt;/name&gt;&lt;album&gt;&lt;name&gt;Wasting Light&lt;/name&gt;&lt;genre&gt;jbox:alternative&lt;/genre&gt;&lt;year&gt;2011&lt;/year&gt;&lt;/album&gt;&lt;/artist&gt;&lt;/library&gt;&lt;/jukebox&gt;]</span><br><span class="line"><span class="comment">################################</span></span><br><span class="line"><span class="comment"># json test</span></span><br><span class="line"><span class="comment"># test datastore的完整版</span></span><br><span class="line">curl -s -i -X PATCH -H <span class="string">"Accept: application/yang-data+json"</span> -d <span class="string">'&#123; "example-jukebox:jukebox" : &#123; "library" : &#123; "artist" : [ &#123; "name" : "Fighters", "album" : [ &#123; "name" : "Light", "genre" : "example-jukebox:alternative", "year" : 2011, "song" : [  &#123; "name" : "Light", "location" :  "/media/foo/a7/wasting-light.mp3", "format" : "MP3", "length" : 286 &#125; ] &#125; ] &#125; ] &#125; &#125; &#125;'</span> http://localhost/restconf/data</span><br><span class="line"></span><br><span class="line"><span class="comment"># data resource版</span></span><br><span class="line">curl -s -i -X PATCH -H <span class="string">"Accept: application/yang-data+json"</span> -d <span class="string">'&#123; "example-jukebox:album" : [ &#123; "name" : "Light", "genre" : "example-jukebox:alternative", "year" : 2011, "song" : [ &#123; "name" : "Light", "location" :  "/media/foo/a7/wasting light.mp3", "format" : "MP3", "length" : 286 &#125; ] &#125; ] &#125;'</span> http://localhost/restconf/data/example-jukebox:jukebox/library/artist=Fighters/album=Light</span><br><span class="line"><span class="comment"># 输入的pretty版</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"example-jukebox:album"</span> : [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"name"</span> : <span class="string">"Light"</span>,</span><br><span class="line">            <span class="string">"genre"</span> : <span class="string">"example-jukebox:alternative"</span>,</span><br><span class="line">            <span class="string">"year"</span> : 2011,</span><br><span class="line">            <span class="string">"song"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                <span class="string">"name"</span> : <span class="string">"Light"</span>,</span><br><span class="line">                <span class="string">"location"</span> :  <span class="string">"/media/foo/a7/wasting-light.mp3"</span>,</span><br><span class="line">                <span class="string">"format"</span> : <span class="string">"MP3"</span>,</span><br><span class="line">                <span class="string">"length"</span> : 286</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 裁剪</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"name"</span> : <span class="string">"Light"</span>,</span><br><span class="line">            <span class="string">"genre"</span> : <span class="string">"example-jukebox:alternative"</span>,</span><br><span class="line">            <span class="string">"year"</span> : 2011,</span><br><span class="line">            <span class="string">"song"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                <span class="string">"name"</span> : <span class="string">"Light"</span>,</span><br><span class="line">                <span class="string">"location"</span> :  <span class="string">"/media/foo/a7/wasting-light.mp3"</span>,</span><br><span class="line">                <span class="string">"format"</span> : <span class="string">"MP3"</span>,</span><br><span class="line">                <span class="string">"length"</span> : 286</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment"># first step  modname + topcontainer//need cbtail</span></span><br><span class="line">&#123; </span><br><span class="line">	<span class="string">"example-jukebox:jukebox"</span> : &#123;</span><br><span class="line"><span class="comment"># second step  container</span></span><br><span class="line">&#123; </span><br><span class="line">	<span class="string">"example-jukebox:jukebox"</span> : &#123;</span><br><span class="line">		<span class="string">"library"</span> : &#123;			<span class="comment"># new line</span></span><br><span class="line"><span class="comment"># third step  list instance with key</span></span><br><span class="line">&#123; </span><br><span class="line">	<span class="string">"example-jukebox:jukebox"</span> : &#123;</span><br><span class="line">		<span class="string">"library"</span> : &#123;			</span><br><span class="line">			<span class="string">"artist"</span> : [		<span class="comment"># new line</span></span><br><span class="line">                &#123;				<span class="comment"># new line</span></span><br><span class="line">					<span class="string">"name"</span> : <span class="string">"Fighters"</span>, <span class="comment"># new line key</span></span><br><span class="line"><span class="comment"># 懒得写了</span></span><br><span class="line">&#123; <span class="string">"example-jukebox:jukebox"</span> : &#123; <span class="string">"library"</span> : &#123; <span class="string">"artist"</span> : [ &#123; <span class="string">"name"</span> : <span class="string">"Fighters"</span>, <span class="string">"album"</span> : [ &#123; <span class="string">"name"</span> : <span class="string">"Light"</span>,  <span class="string">"name"</span> : <span class="string">"Light"</span>, <span class="string">"genre"</span> : <span class="string">"example-jukebox:alternative"</span>, <span class="string">"year"</span> : 2011, <span class="string">"song"</span> : [ &#123; <span class="string">"name"</span> : <span class="string">"Light"</span>, <span class="string">"location"</span> :  <span class="string">"/media/foo/a7/wasting light.mp3"</span>, <span class="string">"format"</span> : <span class="string">"MP3"</span>, <span class="string">"length"</span> : 286 &#125; ] &#125; ] &#125; ] &#125; &#125; &#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123; <span class="string">"example-jukebox:jukebox"</span> : &#123; <span class="string">"library"</span> : &#123; <span class="string">"artist"</span> : [ &#123; <span class="string">"name"</span> : <span class="string">"Fighters"</span>, <span class="string">"album"</span> : [ &#123; <span class="string">"name"</span> : <span class="string">"Light"</span>, <span class="string">"genre"</span> : <span class="string">"example-jukebox:alternative"</span>, <span class="string">"year"</span> : 2011, <span class="string">"song"</span> : [  &#123; <span class="string">"name"</span> : <span class="string">"Light"</span>, <span class="string">"location"</span> :  <span class="string">"/media/foo/a7/wasting-light.mp3"</span>, <span class="string">"format"</span> : <span class="string">"MP3"</span>, <span class="string">"length"</span> : 286 &#125; ] &#125; ] &#125; ] &#125; &#125; &#125;</span><br><span class="line"><span class="comment"># 补全的完整版</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"example-jukebox:jukebox"</span> : &#123;</span><br><span class="line">        <span class="string">"library"</span> : &#123;</span><br><span class="line">            <span class="string">"artist"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">"name"</span> : <span class="string">"Fighters"</span>,</span><br><span class="line">                    <span class="string">"album"</span> : [</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="string">"name"</span> : <span class="string">"Light"</span>,</span><br><span class="line">                            <span class="string">"genre"</span> : <span class="string">"example-jukebox:alternative"</span>,</span><br><span class="line">                            <span class="string">"year"</span> : 2011,</span><br><span class="line">                            <span class="string">"song"</span> : [</span><br><span class="line">                                &#123;</span><br><span class="line">                                <span class="string">"name"</span> : <span class="string">"Light"</span>,</span><br><span class="line">                                <span class="string">"location"</span> :  <span class="string">"/media/foo/a7/wasting-light.mp3"</span>,</span><br><span class="line">                                <span class="string">"format"</span> : <span class="string">"MP3"</span>,</span><br><span class="line">                                <span class="string">"length"</span> : 286</span><br><span class="line">                                &#125;</span><br><span class="line">                            ]</span><br><span class="line">                        &#125;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Error"><a href="#Error" class="headerlink" title="Error"></a>Error</h3><ul>
<li>现在只调研过POST第二次CREATE导致的错误</li>
<li>要了解这个error的格式是否是ietf-netconf的yang定义的</li>
<li>error有关的函数是否在libnetconf2里面</li>
<li>还要了解对于restconf，error要看yang还是看协议正文里面的http错误码</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试xml</span></span><br><span class="line">&lt;rooms xmlns=<span class="string">"urn:building:test"</span> xmlns:nc=<span class="string">"urn:ietf:params:xml:ns:netconf:base:1.0"</span>&gt;</span><br><span class="line">  &lt;room nc:operation=<span class="string">"create"</span>&gt;</span><br><span class="line">    &lt;room-number&gt;12&lt;/room-number&gt;</span><br><span class="line">    &lt;room-name&gt;dabc&lt;/room-name&gt;</span><br><span class="line">    &lt;size&gt;200&lt;/size&gt;</span><br><span class="line">  &lt;/room&gt;</span><br><span class="line">&lt;/rooms&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb 断点位置提示</span></span><br><span class="line">1       breakpoint     keep y   0x000000000041a49c <span class="keyword">in</span> op_editconfig</span><br><span class="line">                                                   at /home/sparta/<span class="built_in">source</span>/Netopeer2-0.7-r1</span><br><span class="line">/server/op_editconfig.c:166</span><br><span class="line">        breakpoint already hit 1 time</span><br><span class="line">2       breakpoint     keep y   0x000000000041157b <span class="keyword">in</span> np2srv_sr_set_item</span><br><span class="line">                                                   at /home/sparta/<span class="built_in">source</span>/Netopeer2-0.7-r1</span><br><span class="line">/server/operations.c:136</span><br><span class="line">        breakpoint already hit 1 time</span><br><span class="line"><span class="comment"># 触发条件：第二次POST同一个内容</span></span><br><span class="line"><span class="comment"># 触发位置：</span></span><br><span class="line">np2srv_sr_set_item 函数内部的</span><br><span class="line">    rc = sr_set_item(srs, xpath, value, opts);</span><br><span class="line"><span class="comment"># rc返回14， 在后续的switch case中，指向</span></span><br><span class="line"><span class="keyword">case</span> SR_ERR_DATA_EXISTS:</span><br><span class="line">    e = nc_err(NC_ERR_DATA_EXISTS, NC_ERR_TYPE_PROT);</span><br><span class="line">    nc_err_set_path(e, xpath);</span><br><span class="line">    <span class="keyword">if</span> (*ereply) &#123;</span><br><span class="line">    nc_server_reply_add_err(*ereply, e);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    *ereply = nc_server_reply_err(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># server端报错</span></span><br><span class="line">[ERR]: (cl_request_process:543) Error by processing of the <span class="built_in">set</span>-item request (session id=61</span><br><span class="line">6876644): The item already exists.</span><br><span class="line">[ERR]: (sr_set_item:1832) Error by processing of the request.</span><br><span class="line"><span class="comment"># client端报错</span></span><br><span class="line">ERROR</span><br><span class="line">	<span class="built_in">type</span>:     application</span><br><span class="line">	tag:      data-exists</span><br><span class="line">	severity: error</span><br><span class="line">	path:     /building:rooms/room[room-number=<span class="string">'12'</span>][room-name=<span class="string">'dabc'</span>]</span><br><span class="line">	message:  Request could not be completed because the relevant data model content already exists.</span><br><span class="line">	</span><br><span class="line"><span class="comment"># error的处理</span></span><br><span class="line">session_server.c nc_server_send_reply_io <span class="keyword">function</span>:</span><br><span class="line">r = nc_write_msg_io(session, io_timeout, NC_MSG_REPLY, rpc-&gt;root, reply);</span><br><span class="line">	<span class="keyword">case</span> NC_MSG_REPLY:</span><br><span class="line">		<span class="keyword">case</span> NC_RPL_ERROR:</span><br><span class="line">            error_rpl = (struct nc_server_reply_error *)reply;</span><br><span class="line">            <span class="keyword">for</span> (i = 0; i &lt; error_rpl-&gt;count; ++i) &#123;</span><br><span class="line">                nc_write_error(&amp;arg, error_rpl-&gt;err[i], base_prefix);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">break</span>;</span><br></pre></td></tr></table></figure>

<h4 id="error-结构体的设定"><a href="#error-结构体的设定" class="headerlink" title="error 结构体的设定"></a>error 结构体的设定</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* error主要就是type, tag, message, path, app-tag是用nc_err_set_app_tag加的*/</span></span><br><span class="line"><span class="keyword">case</span> SR_ERR_DATA_EXISTS:</span><br><span class="line">	<span class="comment">/* nc_err里面会设定type, tag, message*/</span></span><br><span class="line">    e = nc_err(NC_ERR_DATA_EXISTS, NC_ERR_TYPE_PROT);</span><br><span class="line">    <span class="comment">/* 这里设定path */</span></span><br><span class="line">    nc_err_set_path(e, xpath);</span><br><span class="line">    <span class="keyword">if</span> (*ereply) &#123;</span><br><span class="line">        nc_server_reply_add_err(*ereply, e);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        *ereply = nc_server_reply_err(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="comment">// 再列一下：</span></span><br><span class="line">nc_err: 用type和tag创建一个error，内部会调用set_msg</span><br><span class="line">nc_err_set_path</span><br><span class="line">nc_err_set_app_tag</span><br><span class="line">nc_err_set_msg</span><br><span class="line">nc_err_set_sid</span><br><span class="line"><span class="comment">// 对于以上每个函数，都有对应的get替换掉set用来获取相应值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放空间</span></span><br><span class="line">nc_err_free</span><br></pre></td></tr></table></figure>

<h3 id="YANGs"><a href="#YANGs" class="headerlink" title="YANGs"></a>YANGs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/YangModels/yang/tree/master/standard/ietf/RFC</span><br><span class="line"><span class="comment"># basics</span></span><br><span class="line">ietf-ip</span><br><span class="line">ietf-interfaces</span><br><span class="line">ietf-inet-types</span><br><span class="line">ietf-yang-types</span><br><span class="line">ietf-yang-metadata</span><br><span class="line">ietf-yang-library</span><br><span class="line"><span class="comment"># netconf including：</span></span><br><span class="line">ietf-netconf</span><br><span class="line">ietf-netconf-notifications</span><br><span class="line">ietf-netconf- acm</span><br><span class="line">ietf-netconf-with-defaults</span><br><span class="line">ietf-netconf-server</span><br><span class="line">ietf-netconf-monitoring</span><br><span class="line">ietf-ssh-server</span><br><span class="line">ietf-tls-server</span><br><span class="line"><span class="comment"># restconf </span></span><br><span class="line">ietf-restconf</span><br><span class="line">ietf-restconf-monitoring</span><br><span class="line">ietf-restconf-server  <span class="comment">#draft</span></span><br><span class="line">ietf-restconf-transactions@2018-06-11.yang <span class="comment"># 扩展draft</span></span><br><span class="line">ietf-restconf-subscribed-notifications@2019-01-11.yang	<span class="comment"># 扩展draft</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ietf-restconf-monitoring@2017-01-26.yang </span></span><br><span class="line">module: ietf-restconf-monitoring</span><br><span class="line">  +--ro restconf-state</span><br><span class="line">     +--ro capabilities</span><br><span class="line">     |  +--ro capability*   ietf-inet-types:uri</span><br><span class="line">     +--ro streams</span><br><span class="line">        +--ro stream* [name]</span><br><span class="line">           +--ro name                        string</span><br><span class="line">           +--ro description?                string</span><br><span class="line">           +--ro replay-support?             boolean &lt;<span class="literal">false</span>&gt;</span><br><span class="line">           +--ro replay-log-creation-time?   ietf-yang-types:date-and-time</span><br><span class="line">           +--ro access* [encoding]</span><br><span class="line">              +--ro encoding    string</span><br><span class="line">              +--ro location    ietf-inet-types:uri</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ietf-netconf-monitoring.yang </span></span><br><span class="line">module: ietf-netconf-monitoring</span><br><span class="line">  +--ro netconf-state</span><br><span class="line">     +--ro capabilities</span><br><span class="line">     |  +--ro capability*   ietf-inet-types:uri</span><br><span class="line">     +--ro datastores</span><br><span class="line">     |  +--ro datastore* [name]</span><br><span class="line">     |     +--ro name     netconf-datastore-type</span><br><span class="line">     |     +--ro locks!</span><br><span class="line">     |        +--ro (lock-type)?</span><br><span class="line">     |           +--:(global-lock)</span><br><span class="line">     |           |  +--ro global-lock</span><br><span class="line">     |           |     +--ro locked-by-session    uint32</span><br><span class="line">     |           |     +--ro locked-time          ietf-yang-types:date-and-time</span><br><span class="line">     |           +--:(partial-lock)</span><br><span class="line">     |              +--ro partial-lock* [lock-id]</span><br><span class="line">     |                 +--ro lock-id              uint32</span><br><span class="line">     |                 +--ro locked-by-session    uint32</span><br><span class="line">     |                 +--ro locked-time          ietf-yang-types:date-and-time</span><br><span class="line">     |                 +--ro select*              ietf-yang-types:xpath1.0</span><br><span class="line">     |                 +--ro locked-node*         instance-identifier</span><br><span class="line">     +--ro schemas</span><br><span class="line">     |  +--ro schema* [identifier version format]</span><br><span class="line">     |     +--ro identifier    string</span><br><span class="line">     |     +--ro version       string</span><br><span class="line">     |     +--ro format        identityref</span><br><span class="line">     |     +--ro namespace     ietf-inet-types:uri</span><br><span class="line">     |     +--ro location*     union</span><br><span class="line">     +--ro sessions</span><br><span class="line">     |  +--ro session* [session-id]</span><br><span class="line">     |     +--ro session-id           uint32</span><br><span class="line">     |     +--ro transport            identityref</span><br><span class="line">     |     +--ro username             string</span><br><span class="line">     |     +--ro <span class="built_in">source</span>-host?         ietf-inet-types:host</span><br><span class="line">     |     +--ro login-time           ietf-yang-types:date-and-time</span><br><span class="line">     |     +--ro <span class="keyword">in</span>-rpcs?             ietf-yang-types:zero-based-counter32</span><br><span class="line">     |     +--ro <span class="keyword">in</span>-bad-rpcs?         ietf-yang-types:zero-based-counter32</span><br><span class="line">     |     +--ro out-rpc-errors?      ietf-yang-types:zero-based-counter32</span><br><span class="line">     |     +--ro out-notifications?   ietf-yang-types:zero-based-counter32</span><br><span class="line">     +--ro statistics</span><br><span class="line">        +--ro netconf-start-time?   ietf-yang-types:date-and-time</span><br><span class="line">        +--ro <span class="keyword">in</span>-bad-hellos?        ietf-yang-types:zero-based-counter32</span><br><span class="line">        +--ro <span class="keyword">in</span>-sessions?          ietf-yang-types:zero-based-counter32</span><br><span class="line">        +--ro dropped-sessions?     ietf-yang-types:zero-based-counter32</span><br><span class="line">        +--ro <span class="keyword">in</span>-rpcs?              ietf-yang-types:zero-based-counter32</span><br><span class="line">        +--ro <span class="keyword">in</span>-bad-rpcs?          ietf-yang-types:zero-based-counter32</span><br><span class="line">        +--ro out-rpc-errors?       ietf-yang-types:zero-based-counter32</span><br><span class="line">        +--ro out-notifications?    ietf-yang-types:zero-based-counter32</span><br><span class="line"></span><br><span class="line">  rpcs:</span><br><span class="line">    +---x get-schema</span><br><span class="line">       +---- input</span><br><span class="line">       |  +---w identifier    string</span><br><span class="line">       |  +---w version?      string</span><br><span class="line">       |  +---w format?       identityref</span><br><span class="line">       +---- output</span><br><span class="line">          +--ro data?   anyxml</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">module: ietf-netconf</span><br><span class="line"></span><br><span class="line">  rpcs:</span><br><span class="line">    +---x get-config</span><br><span class="line">    |  +---- input</span><br><span class="line">    |  |  +---w <span class="built_in">source</span></span><br><span class="line">    |  |  |  +---w (config-source)</span><br><span class="line">    |  |  |     +--:(running)</span><br><span class="line">    |  |  |        +---w running?   empty</span><br><span class="line">    |  |  +---w filter?   anyxml</span><br><span class="line">    |  +---- output</span><br><span class="line">    |     +--ro data?   anyxml</span><br><span class="line">    +---x edit-config</span><br><span class="line">    |  +---- input</span><br><span class="line">    |     +---w target</span><br><span class="line">    |     |  +---w (config-target)</span><br><span class="line">    |     +---w default-operation?   enumeration &lt;merge&gt;</span><br><span class="line">    |     +---w error-option?        enumeration &lt;stop-on-error&gt;</span><br><span class="line">    |     +---w (edit-content)</span><br><span class="line">    |        +--:(config)</span><br><span class="line">    |           +---w config?   anyxml</span><br><span class="line">    +---x copy-config</span><br><span class="line">    |  +---- input</span><br><span class="line">    |     +---w target</span><br><span class="line">    |     |  +---w (config-target)</span><br><span class="line">    |     +---w <span class="built_in">source</span></span><br><span class="line">    |        +---w (config-source)</span><br><span class="line">    |           +--:(running)</span><br><span class="line">    |           |  +---w running?   empty</span><br><span class="line">    |           +--:(config)</span><br><span class="line">    |              +---w config?   anyxml</span><br><span class="line">    +---x delete-config</span><br><span class="line">    |  +---- input</span><br><span class="line">    |     +---w target</span><br><span class="line">    |        +---w (config-target)</span><br><span class="line">    +---x lock</span><br><span class="line">    |  +---- input</span><br><span class="line">    |     +---w target</span><br><span class="line">    |        +---w (config-target)</span><br><span class="line">    |           +--:(running)</span><br><span class="line">    |              +---w running?   empty</span><br><span class="line">    +---x unlock</span><br><span class="line">    |  +---- input</span><br><span class="line">    |     +---w target</span><br><span class="line">    |        +---w (config-target)</span><br><span class="line">    |           +--:(running)</span><br><span class="line">    |              +---w running?   empty</span><br><span class="line">    +---x get</span><br><span class="line">    |  +---- input</span><br><span class="line">    |  |  +---w filter?   anyxml</span><br><span class="line">    |  +---- output</span><br><span class="line">    |     +--ro data?   anyxml</span><br><span class="line">    +---x close-session</span><br><span class="line">    +---x <span class="built_in">kill</span>-session</span><br><span class="line">       +---- input</span><br><span class="line">          +---w session-id    session-id-type</span><br><span class="line"></span><br><span class="line">ietf-netconf features:</span><br><span class="line">	writable-running  (off)</span><br><span class="line">	candidate         (off)</span><br><span class="line">	confirmed-commit  (off)</span><br><span class="line">	rollback-on-error (off)</span><br><span class="line">	validate          (off)</span><br><span class="line">	startup           (off)</span><br><span class="line">	url               (off)</span><br><span class="line">	xpath             (off)</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ietf-netconf-server.yang</span></span><br><span class="line">module: ietf-netconf-server</span><br><span class="line">  +--rw netconf-server</span><br><span class="line">     +--rw session-options</span><br><span class="line">        +--rw hello-timeout?   uint16 &lt;600&gt;</span><br><span class="line">module: ietf-netconf-server</span><br><span class="line">    +--rw netconf-server</span><br><span class="line">       +--rw session-options</span><br><span class="line">       |  +--rw hello-timeout?   uint16</span><br><span class="line">       +--rw listen &#123;(ssh-listen or tls-listen)&#125;?</span><br><span class="line">       |  +--rw max-sessions?   uint16</span><br><span class="line">       |  +--rw idle-timeout?   uint16</span><br><span class="line">       |  +--rw endpoint* [name]</span><br><span class="line">       |     +--rw name    string</span><br><span class="line">       |     +--rw (transport)</span><br><span class="line">       |        +--:(ssh) &#123;ssh-listen&#125;?</span><br><span class="line">       |        |  +--rw ssh</span><br><span class="line">       |        |     +--rw address?            inet:ip-address</span><br><span class="line">       |        |     +--rw port                inet:port-number</span><br><span class="line">       |        |     +--rw host-keys</span><br><span class="line">       |        |     |  +--rw host-key* [name]</span><br><span class="line">       |        |     |     +--rw name           string</span><br><span class="line">       |        |     |     +--rw (<span class="built_in">type</span>)?</span><br><span class="line">       |        |     |        +--:(public-key)</span><br><span class="line">       |        |     |        |  +--rw public-key?    -&gt; /kc:keychain/p</span><br><span class="line"> rivate-keys/private-key/name</span><br><span class="line">       |        |     |        +--:(certificate)</span><br><span class="line">       |        |     |           +--rw certificate?   -&gt; /kc:keychain/p</span><br><span class="line"> rivate-keys/private-key/certificate-chains/certificate-chain/certificat</span><br><span class="line"> e &#123;ssh-x509-certs&#125;?</span><br><span class="line">       |        |     +--rw client-cert-auth &#123;ssh-x509-certs&#125;?</span><br><span class="line">       |        |        +--rw trusted-ca-certs?       -&gt; /kc:keychain/t</span><br><span class="line"> rusted-certificates/name</span><br><span class="line">       |        |        +--rw trusted-client-certs?   -&gt; /kc:keychain/t</span><br><span class="line"> rusted-certificates/name</span><br><span class="line">       |        +--:(tls) &#123;tls-listen&#125;?</span><br><span class="line">       |           +--rw tls</span><br><span class="line">       |              +--rw address?        inet:ip-address</span><br><span class="line">       |              +--rw port            inet:port-number</span><br><span class="line">       |              +--rw certificates</span><br><span class="line">       |              |  +--rw certificate* [name]</span><br><span class="line">       |              |     +--rw name    -&gt; /kc:keychain/private-keys/p</span><br><span class="line"> rivate-key/certificate-chains/certificate-chain/certificate</span><br><span class="line">       |              +--rw client-auth</span><br><span class="line">       |                 +--rw trusted-ca-certs?       -&gt; /kc:keychain/t</span><br><span class="line"> rusted-certificates/name</span><br><span class="line">       |                 +--rw trusted-client-certs?   -&gt; /kc:keychain/t</span><br><span class="line"> rusted-certificates/name</span><br><span class="line">       |                 +--rw cert-maps</span><br><span class="line">       |                    +--rw cert-to-name* [id]</span><br><span class="line">       |                       +--rw id             uint32</span><br><span class="line">       |                       +--rw fingerprint    x509c2n:tls-fingerpr</span><br><span class="line"> int</span><br><span class="line">       |                       +--rw map-type       identityref</span><br><span class="line">       |                       +--rw name           string</span><br><span class="line">       +--rw call-home &#123;(ssh-call-home or tls-call-home)&#125;?</span><br><span class="line">          +--rw netconf-client* [name]</span><br><span class="line">             +--rw name                  string</span><br><span class="line">             +--rw (transport)</span><br><span class="line">             |  +--:(ssh) &#123;ssh-call-home&#125;?</span><br><span class="line">             |  |  +--rw ssh</span><br><span class="line">             |  |     +--rw endpoints</span><br><span class="line">             |  |     |  +--rw endpoint* [name]</span><br><span class="line">             |  |     |     +--rw name       string</span><br><span class="line">             |  |     |     +--rw address    inet:host</span><br><span class="line">             |  |     |     +--rw port?      inet:port-number</span><br><span class="line">             |  |     +--rw host-keys</span><br><span class="line">             |  |     |  +--rw host-key* [name]</span><br><span class="line">             |  |     |     +--rw name           string</span><br><span class="line">             |  |     |     +--rw (<span class="built_in">type</span>)?</span><br><span class="line">             |  |     |        +--:(public-key)</span><br><span class="line">             |  |     |        |  +--rw public-key?    -&gt; /kc:keychain/p</span><br><span class="line"> rivate-keys/private-key/name</span><br><span class="line">             |  |     |        +--:(certificate)</span><br><span class="line">             |  |     |           +--rw certificate?   -&gt; /kc:keychain/p</span><br><span class="line"> rivate-keys/private-key/certificate-chains/certificate-chain/certificat</span><br><span class="line"> e &#123;ssh-x509-certs&#125;?</span><br><span class="line">             |  |     +--rw client-cert-auth &#123;ssh-x509-certs&#125;?</span><br><span class="line">             |  |        +--rw trusted-ca-certs?       -&gt; /kc:keychain/t</span><br><span class="line"> rusted-certificates/name</span><br><span class="line">             |  |        +--rw trusted-client-certs?   -&gt; /kc:keychain/t</span><br><span class="line"> rusted-certificates/name</span><br><span class="line">             |  +--:(tls) &#123;tls-call-home&#125;?</span><br><span class="line">             |     +--rw tls</span><br><span class="line">             |        +--rw endpoints</span><br><span class="line">             |        |  +--rw endpoint* [name]</span><br><span class="line">             |        |     +--rw name       string</span><br><span class="line">             |        |     +--rw address    inet:host</span><br><span class="line">             |        |     +--rw port?      inet:port-number</span><br><span class="line">             |        +--rw certificates</span><br><span class="line">             |        |  +--rw certificate* [name]</span><br><span class="line">             |        |     +--rw name    -&gt; /kc:keychain/private-keys/p</span><br><span class="line"> rivate-key/certificate-chains/certificate-chain/certificate</span><br><span class="line">             |        +--rw client-auth</span><br><span class="line">             |           +--rw trusted-ca-certs?       -&gt; /kc:keychain/t</span><br><span class="line"> rusted-certificates/name</span><br><span class="line">             |           +--rw trusted-client-certs?   -&gt; /kc:keychain/t</span><br><span class="line"> rusted-certificates/name</span><br><span class="line">             |           +--rw cert-maps</span><br><span class="line">             |              +--rw cert-to-name* [id]</span><br><span class="line">             |                 +--rw id             uint32</span><br><span class="line">             |                 +--rw fingerprint    x509c2n:tls-fingerpr</span><br><span class="line"> int</span><br><span class="line">             |                 +--rw map-type       identityref</span><br><span class="line">             |                 +--rw name           string</span><br><span class="line">             +--rw connection-type</span><br><span class="line">             |  +--rw (connection-type)?</span><br><span class="line">             |     +--:(persistent-connection)</span><br><span class="line">             |     |  +--rw persistent!</span><br><span class="line">             |     |     +--rw idle-timeout?   uint32</span><br><span class="line">             |     |     +--rw keep-alives</span><br><span class="line">             |     |        +--rw max-wait?       uint16</span><br><span class="line">             |     |        +--rw max-attempts?   uint8</span><br><span class="line">             |     +--:(periodic-connection)</span><br><span class="line">             |        +--rw periodic!</span><br><span class="line">             |           +--rw idle-timeout?        uint16</span><br><span class="line">             |           +--rw reconnect_timeout?   uint16</span><br><span class="line">             +--rw reconnect-strategy</span><br><span class="line">                +--rw start-with?     enumeration</span><br><span class="line">                +--rw max-attempts?   uint8</span><br><span class="line"><span class="comment">##########################</span></span><br><span class="line">ietf-netconf-server features:</span><br><span class="line">	listen        (off)</span><br><span class="line">	ssh-listen    (off)</span><br><span class="line">	tls-listen    (off)</span><br><span class="line">	call-home     (off)</span><br><span class="line">	ssh-call-home (off)</span><br><span class="line">	tls-call-home (off)</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">module: ietf-restconf-server</span><br><span class="line">  +--rw restconf-server</span><br><span class="line">     +---u restconf-server-app-grouping</span><br><span class="line"></span><br><span class="line">  grouping restconf-server-grouping</span><br><span class="line">    +-- client-identification</span><br><span class="line">       +-- cert-maps</span><br><span class="line">          +---u x509c2n:cert-to-name</span><br><span class="line">  grouping restconf-server-listen-stack-grouping</span><br><span class="line">    +-- (transport)</span><br><span class="line">       +--:(http) &#123;http-listen&#125;?</span><br><span class="line">       |  +-- http</span><br><span class="line">       |     +-- external-endpoint</span><br><span class="line">       |     |  +-- address    inet:ip-address</span><br><span class="line">       |     |  +-- port?      inet:port-number</span><br><span class="line">       |     +-- tcp-server-parameters</span><br><span class="line">       |     |  +---u tcps:tcp-server-grouping</span><br><span class="line">       |     +-- http-server-parameters</span><br><span class="line">       |     |  +---u https:http-server-grouping</span><br><span class="line">       |     +-- restconf-server-parameters</span><br><span class="line">       |        +---u rcs:restconf-server-grouping</span><br><span class="line">       +--:(https) &#123;https-listen&#125;?</span><br><span class="line">          +-- https</span><br><span class="line">             +-- tcp-server-parameters</span><br><span class="line">             |  +---u tcps:tcp-server-grouping</span><br><span class="line">             +-- tls-server-parameters</span><br><span class="line">             |  +---u tlss:tls-server-grouping</span><br><span class="line">             +-- http-server-parameters</span><br><span class="line">             |  +---u https:http-server-grouping</span><br><span class="line">             +-- restconf-server-parameters</span><br><span class="line">                +---u rcs:restconf-server-grouping</span><br><span class="line">  grouping restconf-server-callhome-stack-grouping</span><br><span class="line">    +-- (transport)</span><br><span class="line">       +--:(https) &#123;https-listen&#125;?</span><br><span class="line">          +-- https</span><br><span class="line">             +-- tcp-client-parameters</span><br><span class="line">             |  +---u tcpc:tcp-client-grouping</span><br><span class="line">             +-- tls-server-parameters</span><br><span class="line">             |  +---u tlss:tls-server-grouping</span><br><span class="line">             +-- http-server-parameters</span><br><span class="line">             |  +---u https:http-server-grouping</span><br><span class="line">             +-- restconf-server-parameters</span><br><span class="line">                +---u rcs:restconf-server-grouping</span><br><span class="line">  grouping restconf-server-app-grouping</span><br><span class="line">    +-- listen! &#123;https-listen&#125;?</span><br><span class="line">    |  +-- endpoint* [name]</span><br><span class="line">    |     +-- name?                                    string</span><br><span class="line">    |     +---u restconf-server-listen-stack-grouping</span><br><span class="line">    +-- call-home! &#123;https-call-home&#125;?</span><br><span class="line">       +-- restconf-client* [name]</span><br><span class="line">          +-- name?                 string</span><br><span class="line">          +-- endpoints</span><br><span class="line">          |  +-- endpoint* [name]</span><br><span class="line">          |     +-- name?                                      string</span><br><span class="line">          |     +---u restconf-server-callhome-stack-grouping</span><br><span class="line">          +-- connection-type</span><br><span class="line">          |  +-- (connection-type)</span><br><span class="line">          |     +--:(persistent-connection)</span><br><span class="line">          |     |  +-- persistent!</span><br><span class="line">          |     +--:(periodic-connection)</span><br><span class="line">          |        +-- periodic!</span><br><span class="line">          |           +-- period?         uint16</span><br><span class="line">          |           +-- anchor-time?    yang:date-and-time</span><br><span class="line">          |           +-- idle-timeout?   uint16</span><br><span class="line">          +-- reconnect-strategy</span><br><span class="line">             +-- start-with?     enumeration</span><br><span class="line">             +-- max-attempts?   uint8</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">module: ietf-netconf-notifications</span><br><span class="line"></span><br><span class="line">  notifications:</span><br><span class="line">    +---n netconf-config-change</span><br><span class="line">    |  +--ro changed-by</span><br><span class="line">    |  |  +--ro (server-or-user)</span><br><span class="line">    |  |     +--:(server)</span><br><span class="line">    |  |     |  +--ro server?   empty</span><br><span class="line">    |  |     +--:(by-user)</span><br><span class="line">    |  |        +--ro username       string</span><br><span class="line">    |  |        +--ro session-id     ietf-netconf:session-id-or-zero-type</span><br><span class="line">    |  |        +--ro <span class="built_in">source</span>-host?   ietf-inet-types:ip-address</span><br><span class="line">    |  +--ro datastore?    enumeration &lt;running&gt;</span><br><span class="line">    |  +--ro edit*</span><br><span class="line">    |     +--ro target?      instance-identifier</span><br><span class="line">    |     +--ro operation?   ietf-netconf:edit-operation-type</span><br><span class="line">    +---n netconf-capability-change</span><br><span class="line">    |  +--ro changed-by</span><br><span class="line">    |  |  +--ro (server-or-user)</span><br><span class="line">    |  |     +--:(server)</span><br><span class="line">    |  |     |  +--ro server?   empty</span><br><span class="line">    |  |     +--:(by-user)</span><br><span class="line">    |  |        +--ro username       string</span><br><span class="line">    |  |        +--ro session-id     ietf-netconf:session-id-or-zero-type</span><br><span class="line">    |  |        +--ro <span class="built_in">source</span>-host?   ietf-inet-types:ip-address</span><br><span class="line">    |  +--ro added-capability*      ietf-inet-types:uri</span><br><span class="line">    |  +--ro deleted-capability*    ietf-inet-types:uri</span><br><span class="line">    |  +--ro modified-capability*   ietf-inet-types:uri</span><br><span class="line">    +---n netconf-session-start</span><br><span class="line">    |  +--ro username       string</span><br><span class="line">    |  +--ro session-id     ietf-netconf:session-id-or-zero-type</span><br><span class="line">    |  +--ro <span class="built_in">source</span>-host?   ietf-inet-types:ip-address</span><br><span class="line">    +---n netconf-session-end</span><br><span class="line">    |  +--ro username              string</span><br><span class="line">    |  +--ro session-id            ietf-netconf:session-id-or-zero-type</span><br><span class="line">    |  +--ro <span class="built_in">source</span>-host?          ietf-inet-types:ip-address</span><br><span class="line">    |  +--ro killed-by?            ietf-netconf:session-id-type</span><br><span class="line">    |  +--ro termination-reason    enumeration</span><br><span class="line">    +---n netconf-confirmed-commit</span><br><span class="line">       +--ro username         string</span><br><span class="line">       +--ro session-id       ietf-netconf:session-id-or-zero-type</span><br><span class="line">       +--ro <span class="built_in">source</span>-host?     ietf-inet-types:ip-address</span><br><span class="line">       +--ro confirm-event    enumeration</span><br><span class="line">       +--ro timeout?         uint32</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">module: ietf-system</span><br><span class="line">  +--rw system</span><br><span class="line">  |  +--rw contact?          string</span><br><span class="line">  |  +--rw hostname?         ietf-inet-types:domain-name</span><br><span class="line">  |  +--rw location?         string</span><br><span class="line">  |  +--rw clock</span><br><span class="line">  |  |  +--rw (timezone)?</span><br><span class="line">  |  |     +--:(timezone-utc-offset)</span><br><span class="line">  |  |        +--rw timezone-utc-offset?   int16</span><br><span class="line">  |  +--rw dns-resolver</span><br><span class="line">  |     +--rw search*    ietf-inet-types:domain-name</span><br><span class="line">  |     +--rw server* [name]</span><br><span class="line">  |     |  +--rw name          string</span><br><span class="line">  |     |  +--rw (transport)</span><br><span class="line">  |     |     +--:(udp-and-tcp)</span><br><span class="line">  |     |        +--rw udp-and-tcp</span><br><span class="line">  |     |           +--rw address    ietf-inet-types:ip-address</span><br><span class="line">  |     +--rw options</span><br><span class="line">  |        +--rw timeout?    uint8 &lt;5&gt;</span><br><span class="line">  |        +--rw attempts?   uint8 &lt;2&gt;</span><br><span class="line">  +--ro system-state</span><br><span class="line">     +--ro platform</span><br><span class="line">     |  +--ro os-name?      string</span><br><span class="line">     |  +--ro os-release?   string</span><br><span class="line">     |  +--ro os-version?   string</span><br><span class="line">     |  +--ro machine?      string</span><br><span class="line">     +--ro clock</span><br><span class="line">        +--ro current-datetime?   ietf-yang-types:date-and-time</span><br><span class="line">        +--ro boot-datetime?      ietf-yang-types:date-and-time</span><br><span class="line"></span><br><span class="line">  rpcs:</span><br><span class="line">    +---x <span class="built_in">set</span>-current-datetime</span><br><span class="line">    |  +---- input</span><br><span class="line">    |     +---w current-datetime    ietf-yang-types:date-and-time</span><br><span class="line">    +---x system-restart</span><br><span class="line">    +---x system-shutdown</span><br><span class="line">&gt; feature ietf-system </span><br><span class="line">ietf-system features:</span><br><span class="line">	radius                (off)</span><br><span class="line">	authentication        (off)</span><br><span class="line">	<span class="built_in">local</span>-users           (off)</span><br><span class="line">	radius-authentication (off)</span><br><span class="line">	ntp                   (off)</span><br><span class="line">	ntp-udp-port          (off)</span><br><span class="line">	timezone-name         (off)</span><br><span class="line">	dns-udp-tcp-port      (off)</span><br></pre></td></tr></table></figure>

<hr>

      
        <div>
          
            <div>
    
        <div style="text-align:center;color: #636363;font-size:14px;letter-spacing: 10px">本文结束啦<i class="fa fa-bell"></i>感谢您的阅读</div>
    
</div>

          
        </div>
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/restconf/" rel="tag"> <i class="fa fa-tag"> </i> restconf</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/09/19/libyang-doc/" rel="next" title="libyang-doc">
                <i class="fa fa-chevron-left"></i> libyang-doc
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/10/21/Install-cgdb-from-source-and-configurate-it-for-c/" rel="prev" title="Install cgdb from source and configurate it for c++">
                Install cgdb from source and configurate it for c++ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="spartazhc">
            
              <p class="site-author-name" itemprop="name">spartazhc</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/spartazhc" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://douban.com/people/130051643" target="_blank" title="豆瓣">
                      
                        <i class="fa fa-fw fa-bug"></i>豆瓣</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#libyang-数据结构"><span class="nav-number">1.</span> <span class="nav-text">libyang 数据结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#schema"><span class="nav-number">2.</span> <span class="nav-text">schema</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#libyang-context-ly-ctx"><span class="nav-number">3.</span> <span class="nav-text">libyang context ly_ctx</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#重要的数据结构"><span class="nav-number">4.</span> <span class="nav-text">重要的数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#libyang"><span class="nav-number">4.1.</span> <span class="nav-text">libyang</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解析的过程"><span class="nav-number">5.</span> <span class="nav-text">解析的过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rpc对比"><span class="nav-number">6.</span> <span class="nav-text">rpc对比</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#clixon"><span class="nav-number">6.1.</span> <span class="nav-text">clixon</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#netopeer2"><span class="nav-number">6.2.</span> <span class="nav-text">netopeer2</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#相关数据结构"><span class="nav-number">6.2.1.</span> <span class="nav-text">相关数据结构</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#cli"><span class="nav-number">6.2.2.</span> <span class="nav-text">cli</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#server"><span class="nav-number">6.2.3.</span> <span class="nav-text">server</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#initiate"><span class="nav-number">7.</span> <span class="nav-text">initiate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#POST-实现"><span class="nav-number">8.</span> <span class="nav-text">POST 实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#restconf"><span class="nav-number">8.1.</span> <span class="nav-text">restconf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#netconf-edit-config"><span class="nav-number">8.2.</span> <span class="nav-text">netconf: edit-config</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#implement"><span class="nav-number">8.3.</span> <span class="nav-text">implement</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#double-POST-error"><span class="nav-number">8.4.</span> <span class="nav-text">double POST error</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Coexistence-with-NETCONF"><span class="nav-number">9.</span> <span class="nav-text">Coexistence with NETCONF</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PUT"><span class="nav-number">10.</span> <span class="nav-text">PUT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Error"><span class="nav-number">11.</span> <span class="nav-text">Error</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#error-结构体的设定"><span class="nav-number">11.1.</span> <span class="nav-text">error 结构体的设定</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#YANGs"><span class="nav-number">12.</span> <span class="nav-text">YANGs</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">spartazhc</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>
  <span>　<i class="fa fa-clock"></i></span>
  <span id="showDays"></span>




<script>
  var seconds = 1000;
  var minutes = seconds * 60;
  var hours = minutes * 60;
  var days = hours * 24;
  var years = days * 365;
  var birthDay = Date.UTC(2019,04,29,00,00,00); // 这里设置建站时间
  setInterval(function() {
    var today = new Date();
    var todayYear = today.getFullYear();
    var todayMonth = today.getMonth()+1;
    var todayDate = today.getDate();
    var todayHour = today.getHours();
    var todayMinute = today.getMinutes();
    var todaySecond = today.getSeconds();
    var now = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond);
    var diff = now - birthDay;
    var diffYears = Math.floor(diff/years);
    var diffDays = Math.floor((diff/days)-diffYears*365);
    var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours);
    var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes);
    var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds);
      document.getElementById('showDays').innerHTML="本站已运行 "+diffYears+" 年 "+diffDays+" 天 "+diffHours+" 小时 "+diffMinutes+" 分钟 "+diffSeconds+" 秒";
  }, 1000);
</script>

        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'CyVb5GcDokobJWn5jYs0YPHx-gzGzoHsz',
        appKey: 'BPpypYK7M7mcSQVUjgoAcQDs',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("CyVb5GcDokobJWn5jYs0YPHx-gzGzoHsz", "BPpypYK7M7mcSQVUjgoAcQDs");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
