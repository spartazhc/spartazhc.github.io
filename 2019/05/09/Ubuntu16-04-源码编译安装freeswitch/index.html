<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="https://fonts.loli.net/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="linux,media,">










<meta name="description" content="在Multimedia的lab2需要我们安装使用freeswitch, 并且因为需要进行视频会议，需要加一些mod，在本机编译安装了freeswitch，总的来说编译安装freeswitch本体还是比较容易的，在编译几个模块的时候碰到一些问题比较麻烦。">
<meta name="keywords" content="linux,media">
<meta property="og:type" content="article">
<meta property="og:title" content="Ubuntu16.04 源码编译安装freeswitch">
<meta property="og:url" content="https://spartazhc.github.io/2019/05/09/Ubuntu16-04-源码编译安装freeswitch/index.html">
<meta property="og:site_name" content="spartazhc&#39;s blog">
<meta property="og:description" content="在Multimedia的lab2需要我们安装使用freeswitch, 并且因为需要进行视频会议，需要加一些mod，在本机编译安装了freeswitch，总的来说编译安装freeswitch本体还是比较容易的，在编译几个模块的时候碰到一些问题比较麻烦。">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-05-20T15:31:56.104Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ubuntu16.04 源码编译安装freeswitch">
<meta name="twitter:description" content="在Multimedia的lab2需要我们安装使用freeswitch, 并且因为需要进行视频会议，需要加一些mod，在本机编译安装了freeswitch，总的来说编译安装freeswitch本体还是比较容易的，在编译几个模块的时候碰到一些问题比较麻烦。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":20,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://spartazhc.github.io/2019/05/09/Ubuntu16-04-源码编译安装freeswitch/">





  <title>Ubuntu16.04 源码编译安装freeswitch | spartazhc's blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">spartazhc's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://spartazhc.github.io/2019/05/09/Ubuntu16-04-源码编译安装freeswitch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="spartazhc">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="spartazhc's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Ubuntu16.04 源码编译安装freeswitch</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-09T17:01:18+08:00">
                2019-05-09
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/media/" itemprop="url" rel="index">
                    <span itemprop="name">media</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/media/tools/" itemprop="url" rel="index">
                    <span itemprop="name">tools</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/05/09/Ubuntu16-04-源码编译安装freeswitch/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/05/09/Ubuntu16-04-源码编译安装freeswitch/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/05/09/Ubuntu16-04-源码编译安装freeswitch/" class="leancloud_visitors" data-flag-title="Ubuntu16.04 源码编译安装freeswitch">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      
        <div class="note default"><p>在Multimedia的lab2需要我们安装使用freeswitch, 并且因为需要进行视频会议，需要加一些mod，在本机编译安装了freeswitch，总的来说编译安装freeswitch本体还是比较容易的，在编译几个模块的时候碰到一些问题比较麻烦。</p></div>

<a id="more"></a>

<h3 id="源码获取"><a href="#源码获取" class="headerlink" title="源码获取"></a>源码获取</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://freeswitch.org/stash/scm/fs/freeswitch.git</span><br></pre></td></tr></table></figure>

<p>因为我本机在校园网下使用git clone 会报错，所以直接去下载了tar.gz源码包<a href="https://files.freeswitch.org/freeswitch-releases/" target="_blank" rel="noopener">freeswitch-1.8.5</a>，但是后来在寝室测试直接git clone 也可以。git clone 地址：<a href="https://freeswitch.org/stash/projects/FS/repos/freeswitch/browse" target="_blank" rel="noopener">https://freeswitch.org/stash/projects/FS/repos/freeswitch/browse</a>，可以点tag找自己想要的版本</p>
<p>后来因为缺mod，图省事就使用了和助教一样的版本1.6.19。</p>
<h3 id="安装环境依赖"><a href="#安装环境依赖" class="headerlink" title="安装环境依赖"></a>安装环境依赖</h3><p>安装编译需要的lib库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get -y install build-essential subversion automake autoconf wget libtool libncurses5-dev libspeex-dev libspeexdsp-dev sqlite3 libsqlite3-dev libcurl4-openssl-dev  libldns-dev libedit-dev libssl-dev pkg-config yasm liblua50-dev libopus-dev libsndfile-dev libpq-dev pkg-config lua5.2 lua5.2-doc liblua5.2-dev libreadline-dev</span><br></pre></td></tr></table></figure>

<h3 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h3><h4 id="编译更多模块"><a href="#编译更多模块" class="headerlink" title="编译更多模块"></a>编译更多模块</h4><p>freeswitch可以通过动态加载模块，如果需要编译更多的模块，有两种方法：</p>
<ul>
<li>编辑<code>freeswitch/modules.conf</code>文件，找到要安装的模块，去掉前面的注释符号#，然后需要重新执行<code>./configure</code>，编译整个freeswitch。</li>
<li>在命令行执行<code>make mod_xxx-install</code>命令，这样就编译相应模块，并把编译后的动态库安装的<code>/usr/local/freeswitch/mod</code>目录下了。</li>
</ul>
<p>编译安装完以后，</p>
<ul>
<li>可以通过启动freeswitch后运行<code>load mod_xxx</code>来测试相应模块的编译是否成功。</li>
<li>也可以修改<code>/usr/local/freeswitch/conf/autoload_configs/modules.conf.xml</code>设置freeswitch启动时自动加载的模块。</li>
</ul>
<h4 id="编译本体"><a href="#编译本体" class="headerlink" title="编译本体"></a>编译本体</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编译安装</span></span><br><span class="line">./bootstrap.sh   <span class="comment">#如果是tar包则省略这一步</span></span><br><span class="line">./configure</span><br><span class="line">make -j8</span><br><span class="line">sudo make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 软连接创建</span></span><br><span class="line">ln -sf /usr/<span class="built_in">local</span>/freeswitch/bin/freeswitch /usr/<span class="built_in">local</span>/bin/</span><br><span class="line">ln -sf /usr/<span class="built_in">local</span>/freeswitch/bin/fs_cli /usr/<span class="built_in">local</span>/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装声音文件</span></span><br><span class="line">sudo make <span class="built_in">cd</span>-sounds-install</span><br><span class="line">sudo make <span class="built_in">cd</span>-moh-install</span><br></pre></td></tr></table></figure>

<p>编译成功以后，运行<code>sudo freeswitch</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">.=============================================================.</span><br><span class="line">|   _____              ______        _____ _____ ____ _   _   |</span><br><span class="line">|  |  ___| __ ___  ___/ ___\ \      / /_ _|_   _/ ___| | | |  |</span><br><span class="line">|  | |_ | <span class="string">'__/ _ \/ _ \___ \\ \ /\ / / | |  | || |   | |_| |  |</span></span><br><span class="line"><span class="string">|  |  _|| | |  __/  __/___) |\ V  V /  | |  | || |___|  _  |  |</span></span><br><span class="line"><span class="string">|  |_|  |_|  \___|\___|____/  \_/\_/  |___| |_| \____|_| |_|  |</span></span><br><span class="line"><span class="string">|                                                             |</span></span><br><span class="line"><span class="string">.=============================================================.</span></span><br><span class="line"><span class="string">|   Anthony Minessale II, Michael Jerris, Brian West, Others  |</span></span><br><span class="line"><span class="string">|   FreeSWITCH (http://www.freeswitch.org)                    |</span></span><br><span class="line"><span class="string">|   Paypal Donations Appreciated: paypal@freeswitch.org       |</span></span><br><span class="line"><span class="string">|   Brought to you by ClueCon http://www.cluecon.com/         |</span></span><br><span class="line"><span class="string">.=============================================================.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">.===============================================================.</span></span><br><span class="line"><span class="string">|       _                                                       |</span></span><br><span class="line"><span class="string">|   ___| |_   _  ___  ___ ___  _ __         ___ ___  _ __ ___   |</span></span><br><span class="line"><span class="string">|  / __| | | | |/ _ \/ __/ _ \| '</span>_ \       / __/ _ \| <span class="string">'_ ` _ \  |</span></span><br><span class="line"><span class="string">| | (__| | |_| |  __/ (_| (_) | | | |  _  | (_| (_) | | | | | | |</span></span><br><span class="line"><span class="string">|  \___|_|\__,_|\___|\___\___/|_| |_| (_)  \___\___/|_| |_| |_| |</span></span><br><span class="line"><span class="string">|                                                               |</span></span><br><span class="line"><span class="string">.===============================================================.</span></span><br><span class="line"><span class="string">/</span></span><br><span class="line"><span class="string">2019-05-09 17:15:32.605630 [INFO] switch_core.c:2436 </span></span><br><span class="line"><span class="string">FreeSWITCH Version 1.6.19~64bit ( 64bit)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">FreeSWITCH Started</span></span><br><span class="line"><span class="string">Max Sessions [1000]</span></span><br><span class="line"><span class="string">Session Rate [30]</span></span><br><span class="line"><span class="string">SQL [Enabled]</span></span><br></pre></td></tr></table></figure>

<h3 id="报错及解决"><a href="#报错及解决" class="headerlink" title="报错及解决"></a>报错及解决</h3><p>注意：在安装了新的lib之类的修改以后要重新执行<code>./configure</code>。</p>
<h4 id="error1-fatal-error-lua-h"><a href="#error1-fatal-error-lua-h" class="headerlink" title="[error1]: fatal error: lua.h"></a>[error1]: fatal error: lua.h</h4><h4 id="solution1"><a href="#solution1" class="headerlink" title="[solution1]"></a>[solution1]</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /usr/include/lua5.2/*.h  ./src/mod/languages/mod_lua/</span><br><span class="line">sudo ln -s /usr/lib/x86_64-linux-gnu/liblua5.2.so /usr/lib/x86_64-linux-gnu/liblua.somake</span><br></pre></td></tr></table></figure>

<h4 id="error2-Makefile-930-You-must-install-libks-to-build-mod-signalwire"><a href="#error2-Makefile-930-You-must-install-libks-to-build-mod-signalwire" class="headerlink" title="[error2]: Makefile:930: *** You must install libks to build mod_signalwire."></a>[error2]: Makefile:930: *** You must install libks to build mod_signalwire.</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">making all mod_signalwire</span><br><span class="line">make[4]: Entering directory <span class="string">'/home/color/freeswitchls/src/freeswitch/src/mod/applications/mod_signalwire'</span></span><br><span class="line">Makefile:930: *** You must install libks to build mod_signalwire.  Stop.</span><br><span class="line">make[4]: Leaving directory <span class="string">'/home/color/freeswitch/src/freeswitch/src/mod/applications/mod_signalwire'</span></span><br><span class="line">Makefile:683: recipe <span class="keyword">for</span> target <span class="string">'mod_signalwire-all'</span> failed</span><br><span class="line">make: *** [all] Error 2</span><br></pre></td></tr></table></figure>

<h4 id="solusion2"><a href="#solusion2" class="headerlink" title="[solusion2]"></a>[solusion2]</h4><p>安装 libks 和 signalwire</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># libks</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/signalwire/libks.git</span><br><span class="line"><span class="built_in">cd</span> libks</span><br><span class="line">/usr/<span class="built_in">local</span>/bin/cmake .</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br><span class="line"><span class="comment"># signalwire</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/signalwire/signalwire-c.git</span><br><span class="line"><span class="built_in">cd</span> signalwire-c</span><br><span class="line">/usr/<span class="built_in">local</span>/bin/cmake .</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br><span class="line">cp /usr/<span class="built_in">local</span>/lib/pkgconfig/*.pc /usr/lib/pkgconfig/</span><br><span class="line">cp -f /usr/<span class="built_in">local</span>/lib/* /usr/lib64/</span><br></pre></td></tr></table></figure>

<p>其中，安装libks时出现：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- Checking <span class="keyword">for</span> module <span class="string">'uuid'</span></span><br><span class="line">--   No package <span class="string">'uuid'</span> found</span><br></pre></td></tr></table></figure>

<p>需要再手动安装一下uuid</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install uuid-dev</span><br></pre></td></tr></table></figure>

<h4 id="error3-：安装mod-av的时候一直报错"><a href="#error3-：安装mod-av的时候一直报错" class="headerlink" title="[error3]：安装mod_av的时候一直报错"></a>[error3]：安装mod_av的时候一直报错</h4><p>很奇怪的是，这个报错不讲缺什么，讲的是函数接口deprecated，导致弄了挺久才发现要这么干。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">mod_av.c: In <span class="keyword">function</span> ‘mod_av_shutdown’:</span><br><span class="line">mod_av.c:121:2: error: ‘av_lockmgr_register’ is deprecated [-Werror=deprecated-declarations]</span><br><span class="line">  av_lockmgr_register(NULL);</span><br><span class="line">  ^</span><br><span class="line">In file included from mod_av.c:34:0:</span><br><span class="line">/usr/include/x86_64-linux-gnu/libavcodec/avcodec.h:6103:5: note: declared here</span><br><span class="line"> int av_lockmgr_register(int (*cb)(void **mutex, enum AVLockOp op));</span><br><span class="line">     ^</span><br><span class="line">mod_av.c: In <span class="keyword">function</span> ‘mod_av_load’:</span><br><span class="line">mod_av.c:127:2: error: ‘av_lockmgr_register’ is deprecated [-Werror=deprecated-declarations]</span><br><span class="line">  av_lockmgr_register(&amp;mod_av_lockmgr_cb);</span><br><span class="line">  ^</span><br><span class="line">In file included from mod_av.c:34:0:</span><br><span class="line">/usr/include/x86_64-linux-gnu/libavcodec/avcodec.h:6103:5: note: declared here</span><br><span class="line"> int av_lockmgr_register(int (*cb)(void **mutex, enum AVLockOp op));</span><br><span class="line">     ^</span><br><span class="line">mod_av.c:131:2: error: ‘av_register_all’ is deprecated [-Werror=deprecated-declarations]</span><br><span class="line">  av_register_all();</span><br><span class="line">  ^</span><br><span class="line">In file included from mod_av.c:35:0:</span><br><span class="line">/usr/include/x86_64-linux-gnu/libavformat/avformat.h:2043:6: note: declared here</span><br><span class="line"> void av_register_all(void);</span><br><span class="line">      ^</span><br><span class="line">cc1: all warnings being treated as errors</span><br><span class="line">Makefile:681: recipe <span class="keyword">for</span> target <span class="string">'mod_av_la-mod_av.lo'</span> failed</span><br><span class="line">make[4]: *** [mod_av_la-mod_av.lo] Error 1</span><br><span class="line">make[4]: Leaving directory <span class="string">'/opt/freeswitch-1.6.19/src/mod/applications/mod_av'</span></span><br><span class="line">Makefile:667: recipe <span class="keyword">for</span> target <span class="string">'mod_av-all'</span> failed</span><br></pre></td></tr></table></figure>

<h4 id="solution3-需要安装libav"><a href="#solution3-需要安装libav" class="headerlink" title="[solution3]:需要安装libav"></a>[solution3]:需要安装libav</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install yasm libvpx. libx264. libx264-dev</span><br><span class="line"><span class="comment"># install libav</span></span><br><span class="line">git <span class="built_in">clone</span> https://freeswitch.org/stash/scm/sd/libav.git</span><br><span class="line"><span class="built_in">cd</span> libav</span><br><span class="line">./configure --<span class="built_in">enable</span>-shared --<span class="built_in">enable</span>-libx264 --<span class="built_in">enable</span>-gpl</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<h4 id="error4-安装mod-shout缺包"><a href="#error4-安装mod-shout缺包" class="headerlink" title="[error4]: 安装mod_shout缺包"></a>[error4]: 安装mod_shout缺包</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Makefile:932: *** You must install libshout3-dev to build mod_shout。 停止。</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libshout3-dev</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Makefile:927: *** You must install libmpg123-dev to build mod_shout。 停止。</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libmpg123-dev</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Makefile:922: *** You must install libmp3lame-dev to build mod_shout。 停止。</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libmp3lame-dev</span><br></pre></td></tr></table></figure>

<h4 id="error5-You-must-install-libilbc-dev-to-build-mod-ilbc"><a href="#error5-You-must-install-libilbc-dev-to-build-mod-ilbc" class="headerlink" title="[error5]: You must install libilbc-dev to build mod_ilbc"></a>[error5]: You must install libilbc-dev to build mod_ilbc</h4><h4 id="solution5"><a href="#solution5" class="headerlink" title="[solution5]"></a>[solution5]</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># install libilbc 因为apt包里没有libilbc-dev</span><br><span class="line">git clone https://freeswitch.org/stash/scm/sd/libilbc.git</span><br><span class="line">./bootstrap.sh</span><br><span class="line">./configure</span><br><span class="line">make -j8</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h3 id="验证安装"><a href="#验证安装" class="headerlink" title="验证安装"></a>验证安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">sparta:~$ sudo freeswitch </span><br><span class="line">2019-05-13 13:55:15.895884 [INFO] switch_event.c:685 Activate Eventing Engine.</span><br><span class="line">......</span><br><span class="line">2019-05-13 13:55:36.037369 [CONSOLE] switch_core.c:2427 </span><br><span class="line">.=============================================================.</span><br><span class="line">|   _____              ______        _____ _____ ____ _   _   |</span><br><span class="line">|  |  ___| __ ___  ___/ ___\ \      / /_ _|_   _/ ___| | | |  |</span><br><span class="line">|  | |_ | <span class="string">'__/ _ \/ _ \___ \\ \ /\ / / | |  | || |   | |_| |  |</span></span><br><span class="line"><span class="string">|  |  _|| | |  __/  __/___) |\ V  V /  | |  | || |___|  _  |  |</span></span><br><span class="line"><span class="string">|  |_|  |_|  \___|\___|____/  \_/\_/  |___| |_| \____|_| |_|  |</span></span><br><span class="line"><span class="string">|                                                             |</span></span><br><span class="line"><span class="string">.=============================================================.</span></span><br><span class="line"><span class="string">|   Anthony Minessale II, Michael Jerris, Brian West, Others  |</span></span><br><span class="line"><span class="string">|   FreeSWITCH (http://www.freeswitch.org)                    |</span></span><br><span class="line"><span class="string">|   Paypal Donations Appreciated: paypal@freeswitch.org       |</span></span><br><span class="line"><span class="string">|   Brought to you by ClueCon http://www.cluecon.com/         |</span></span><br><span class="line"><span class="string">.=============================================================.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">.===============================================================.</span></span><br><span class="line"><span class="string">|       _                                                       |</span></span><br><span class="line"><span class="string">|   ___| |_   _  ___  ___ ___  _ __         ___ ___  _ __ ___   |</span></span><br><span class="line"><span class="string">|  / __| | | | |/ _ \/ __/ _ \| '</span>_ \       / __/ _ \| <span class="string">'_ ` _ \  |</span></span><br><span class="line"><span class="string">| | (__| | |_| |  __/ (_| (_) | | | |  _  | (_| (_) | | | | | | |</span></span><br><span class="line"><span class="string">|  \___|_|\__,_|\___|\___\___/|_| |_| (_)  \___\___/|_| |_| |_| |</span></span><br><span class="line"><span class="string">|                                                               |</span></span><br><span class="line"><span class="string">.===============================================================.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2019-05-13 13:55:36.037382 [INFO] switch_core.c:2436 </span></span><br><span class="line"><span class="string">FreeSWITCH Version 1.6.19~64bit ( 64bit)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">FreeSWITCH Started</span></span><br><span class="line"><span class="string">Max Sessions [1000]</span></span><br><span class="line"><span class="string">Session Rate [30]</span></span><br><span class="line"><span class="string">SQL [Enabled]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### freeswitch 默认号码说明</span><br></pre></td></tr></table></figure>

<p>9999 | 保持音乐<br>9996 | echo，回音测试<br>9992 | info，在控制台上显示呼叫参数<br>9888 | FreeSWITCH电话会议，每周召开<br>5900 | 呼叫挂起<br>5901 | 接听挂起的呼叫<br>5000 | 示例IVR<br>4000 | 听取语音信箱<br>33xx | 电话会议，48K(其中xx可为00-99，下同)<br>32xx | 电话会议，32K<br>31xx | 电话会议，16K<br>30xx | 电话会议，8K<br>2000-2002 | 呼叫组<br>1000-1019 | 默认分机号<br>```</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://blog.csdn.net/Reasonss/article/details/81171288" target="_blank" rel="noopener">Ubuntu16.04从零开始freeSWITCH安装</a></li>
<li><a href="https://wsonh.com/article/22.html" target="_blank" rel="noopener">在ubuntu16.04部署配置安装freeswitch以及常见问题解决</a></li>
<li><a href="https://www.codetd.com/article/5754468" target="_blank" rel="noopener">Ubuntu 16.04 install FreeSWITCH v1.8</a></li>
<li><a href="https://blog.csdn.net/u011745859/article/details/82150814" target="_blank" rel="noopener">FreeSwitch 1.9.0支持H264的视频会议配置</a></li>
<li><a href="https://blog.csdn.net/Java_lilin/article/details/78121184" target="_blank" rel="noopener">ubuntu16.04 编译freeswitch1.9的视频mod_av模块</a></li>
</ul>
<hr>

      
        <div>
          
            <div>
    
        <div style="text-align:center;color: #636363;font-size:14px;letter-spacing: 10px">本文结束啦<i class="fa fa-bell"></i>感谢您的阅读</div>
    
</div>

          
        </div>
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/linux/" rel="tag"> <i class="fa fa-tag"> </i> linux</a>
          
            <a href="/tags/media/" rel="tag"> <i class="fa fa-tag"> </i> media</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/05/05/sharelatex本地部署小记/" rel="next" title="sharelatex本地部署小记">
                <i class="fa fa-chevron-left"></i> sharelatex本地部署小记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/05/11/Ubuntu16-04-unity-plugins-install/" rel="prev" title="Ubuntu16.04 unity plugins install">
                Ubuntu16.04 unity plugins install <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="spartazhc">
            
              <p class="site-author-name" itemprop="name">spartazhc</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">22</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/spartazhc" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://douban.com/people/130051643" target="_blank" title="豆瓣">
                      
                        <i class="fa fa-fw fa-bug"></i>豆瓣</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#源码获取"><span class="nav-number">1.</span> <span class="nav-text">源码获取</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装环境依赖"><span class="nav-number">2.</span> <span class="nav-text">安装环境依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编译安装"><span class="nav-number">3.</span> <span class="nav-text">编译安装</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#编译更多模块"><span class="nav-number">3.1.</span> <span class="nav-text">编译更多模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编译本体"><span class="nav-number">3.2.</span> <span class="nav-text">编译本体</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#报错及解决"><span class="nav-number">4.</span> <span class="nav-text">报错及解决</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#error1-fatal-error-lua-h"><span class="nav-number">4.1.</span> <span class="nav-text">[error1]: fatal error: lua.h</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#solution1"><span class="nav-number">4.2.</span> <span class="nav-text">[solution1]</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#error2-Makefile-930-You-must-install-libks-to-build-mod-signalwire"><span class="nav-number">4.3.</span> <span class="nav-text">[error2]: Makefile:930: *** You must install libks to build mod_signalwire.</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#solusion2"><span class="nav-number">4.4.</span> <span class="nav-text">[solusion2]</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#error3-：安装mod-av的时候一直报错"><span class="nav-number">4.5.</span> <span class="nav-text">[error3]：安装mod_av的时候一直报错</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#solution3-需要安装libav"><span class="nav-number">4.6.</span> <span class="nav-text">[solution3]:需要安装libav</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#error4-安装mod-shout缺包"><span class="nav-number">4.7.</span> <span class="nav-text">[error4]: 安装mod_shout缺包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#error5-You-must-install-libilbc-dev-to-build-mod-ilbc"><span class="nav-number">4.8.</span> <span class="nav-text">[error5]: You must install libilbc-dev to build mod_ilbc</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#solution5"><span class="nav-number">4.9.</span> <span class="nav-text">[solution5]</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证安装"><span class="nav-number">5.</span> <span class="nav-text">验证安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考"><span class="nav-number">6.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">spartazhc</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>
  <span>　<i class="fa fa-clock"></i></span>
  <span id="showDays"></span>




<script>
  var seconds = 1000;
  var minutes = seconds * 60;
  var hours = minutes * 60;
  var days = hours * 24;
  var years = days * 365;
  var birthDay = Date.UTC(2019,04,29,00,00,00); // 这里设置建站时间
  setInterval(function() {
    var today = new Date();
    var todayYear = today.getFullYear();
    var todayMonth = today.getMonth()+1;
    var todayDate = today.getDate();
    var todayHour = today.getHours();
    var todayMinute = today.getMinutes();
    var todaySecond = today.getSeconds();
    var now = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond);
    var diff = now - birthDay;
    var diffYears = Math.floor(diff/years);
    var diffDays = Math.floor((diff/days)-diffYears*365);
    var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours);
    var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes);
    var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds);
      document.getElementById('showDays').innerHTML="本站已运行 "+diffYears+" 年 "+diffDays+" 天 "+diffHours+" 小时 "+diffMinutes+" 分钟 "+diffSeconds+" 秒";
  }, 1000);
</script>

        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'CyVb5GcDokobJWn5jYs0YPHx-gzGzoHsz',
        appKey: 'BPpypYK7M7mcSQVUjgoAcQDs',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("CyVb5GcDokobJWn5jYs0YPHx-gzGzoHsz", "BPpypYK7M7mcSQVUjgoAcQDs");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
